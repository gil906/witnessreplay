<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
    <meta name="description" content="AI-Powered Crime Scene Reconstruction - Report incidents using voice or text">
    <meta name="theme-color" content="#0a0a0f">
    <meta property="og:title" content="WitnessReplay">
    <meta property="og:description" content="AI-Powered Crime Scene Reconstruction">
    <meta property="og:type" content="website">
    <title>WitnessReplay - Report an Incident</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
    
    <!-- Modern Fonts: Inter & JetBrains Mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Skip to content link (Accessibility) -->
    <a href="#chat-transcript" class="skip-to-content">Skip to main content</a>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">ğŸ›¡ï¸</div>
                    <div class="logo-text">
                        <h1>WitnessReplay</h1>
                        <p class="tagline">AI-Powered Witness Interview &amp; Scene Reconstruction</p>
                        <p class="tagline-sub">Powered by Google Gemini â€¢ Built for Law Enforcement</p>
                    </div>
                    <span class="challenge-badge">Gemini Live Agent Challenge</span>
                </div>
                
                <div class="session-info">
                    <div class="connection-status connecting" id="connection-status" title="Click for details" role="button" tabindex="0" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click();}">
                        <span class="status-dot"></span>
                        <span class="status-spinner"></span>
                        <span class="status-text">Connecting...</span>
                        <div class="connection-popup" id="connection-popup">
                            <div class="connection-popup-body">
                                <div class="connection-popup-state" id="popup-state">â³ Connecting to server...</div>
                                <div class="connection-popup-detail" id="popup-ws-url" style="display:none;"></div>
                                <div class="connection-popup-session" id="popup-session" style="display:none;"></div>
                                <div class="connection-popup-error" id="popup-error" style="display:none;"></div>
                                <div class="connection-popup-steps" id="popup-steps"></div>
                            </div>
                            <button class="connection-popup-retry" id="popup-retry-btn">Retry Connection</button>
                        </div>
                    </div>
                    <span id="connection-quality-badge" class="connection-quality-badge" data-level="unstable" aria-live="polite">Unstable</span>
                    <div class="session-status" style="display:none;">
                        <span class="status-dot"></span>
                        <span id="session-id">Initializing...</span>
                    </div>
                    <button id="new-session-btn" class="btn btn-secondary header-menu-item" aria-label="Start new report">
                        â• New Report
                    </button>
                    <!-- Hidden technical buttons (IDs preserved for app.js) -->
                    <button id="sessions-list-btn" class="btn btn-secondary" style="display:none;" data-tooltip="View all sessions" aria-label="View all sessions">ğŸ“‹ Sessions</button>
                    <button id="quota-btn" class="btn btn-secondary" style="display:none;" data-tooltip="Model & Quota" aria-label="Model and quota info">ğŸ¤– Model</button>
                    <button id="analytics-btn" class="btn btn-secondary" style="display:none;" data-tooltip="View analytics" aria-label="View session analytics">ğŸ“Š Analytics</button>
                    <button id="info-btn" class="btn btn-secondary" style="display:none;" data-tooltip="Server info" aria-label="Server information">â„¹ï¸ Info</button>
                    <button id="theme-toggle" class="theme-toggle header-menu-item" onclick="toggleTheme()" aria-label="Toggle dark/light theme" title="Toggle theme">
                        <span class="theme-icon">ğŸŒ™</span>
                    </button>
                    <button id="admin-portal-btn" class="btn btn-primary header-menu-item" data-tooltip="Admin Portal" aria-label="Open admin portal">
                        ğŸ›¡ï¸ Admin
                    </button>
                    <!-- Hamburger menu button (mobile only) -->
                    <button id="hamburger-menu-btn" class="hamburger-menu-btn" aria-label="Open menu" onclick="document.getElementById('mobile-menu-overlay').classList.toggle('open'); document.getElementById('mobile-menu-dropdown').classList.toggle('open')">
                        â˜°
                    </button>
                </div>
                <!-- Mobile menu backdrop overlay -->
                <div id="mobile-menu-overlay" class="mobile-menu-overlay" onclick="document.getElementById('mobile-menu-overlay').classList.remove('open'); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');"></div>
                <!-- Mobile dropdown menu â€” iOS action sheet style -->
                <div id="mobile-menu-dropdown" class="mobile-menu-dropdown">
                    <button onclick="document.getElementById('new-session-btn').click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">â• New Report</button>
                    <button onclick="document.getElementById('tts-toggle-btn')?.click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item" id="mobile-speaker-item">ğŸ”Š Speaker</button>
                    <button onclick="toggleTheme(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">ğŸŒ™ Dark Mode</button>
                    <button onclick="document.getElementById('admin-portal-btn').click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">ğŸ›¡ï¸ Admin</button>
                    <hr class="mobile-menu-divider">
                    <div class="mobile-menu-section-label">Actions</div>
                    <button onclick="document.querySelector('[data-action=correct]')?.click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">âœï¸ Correct something</button>
                    <button onclick="document.querySelector('[data-action=generate]')?.click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">ğŸ¬ Generate scene</button>
                    <button onclick="document.querySelector('[data-action=details]')?.click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">â• Add more details</button>
                    <hr class="mobile-menu-divider">
                    <div class="mobile-menu-section-label">Settings</div>
                    <button onclick="document.getElementById('guided-mode-btn')?.click(); this.textContent = document.getElementById('guided-mode-btn')?.classList.contains('active') ? 'ğŸ“‹ Guided Mode âœ“' : 'ğŸ“‹ Guided Mode';" class="mobile-menu-item" id="mobile-guided-item">ğŸ“‹ Guided Mode</button>
                    <button onclick="document.getElementById('child-mode-btn')?.click(); this.textContent = document.getElementById('child-mode-btn')?.classList.contains('active') ? 'ğŸ§’ Child Mode âœ“' : 'ğŸ§’ Child Mode';" class="mobile-menu-item" id="mobile-child-item">ğŸ§’ Child Mode</button>
                    <button onclick="document.getElementById('high-contrast-btn')?.click(); this.textContent = document.getElementById('high-contrast-btn')?.classList.contains('active') ? 'ğŸ”² High Contrast âœ“' : 'ğŸ”² High Contrast';" class="mobile-menu-item" id="mobile-hc-item">ğŸ”² High Contrast</button>
                    <hr class="mobile-menu-divider">
                    <button onclick="document.getElementById('comfort-pause-btn')?.click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">â¸ï¸ Pause</button>
                    <button onclick="document.getElementById('comfort-break-btn')?.click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">â˜• Take Break</button>
                    <button onclick="document.getElementById('comfort-support-btn')?.click(); document.getElementById('mobile-menu-dropdown').classList.remove('open'); document.getElementById('mobile-menu-overlay').classList.remove('open');" class="mobile-menu-item">ğŸ’š Support</button>
                    <div class="mobile-menu-item mobile-menu-info">â±ï¸ Duration: <span id="mobile-duration-display">0:00</span></div>
                </div>
            </div>
        </header>

        <!-- Main Content: 2-Column Layout â€” Chat Primary (left) | Scene Secondary (right) -->
        <div class="main-content" id="main-workspace">
            <!-- LEFT COLUMN: Primary - Chat & Voice -->
            <section class="chat-panel" role="main">
                <!-- Step indicator showing how reporting works -->
                <div class="reporting-steps">
                    <div class="step active"><span class="step-num">1</span> Describe Incident</div>
                    <div class="step"><span class="step-num">2</span> Answer Questions</div>
                    <div class="step"><span class="step-num">3</span> Review &amp; Export</div>
                </div>

                <!-- Multi-Witness Selector Bar -->
                <div id="witness-selector-bar" class="witness-selector-bar" style="display:none;">
                    <div class="witness-tabs" id="witness-tabs">
                        <!-- Witness tabs populated dynamically -->
                    </div>
                    <button id="add-witness-btn" class="btn btn-secondary btn-sm" title="Add another witness">
                        <span class="btn-icon">+</span> Add Witness
                    </button>
                </div>

                <!-- Interview Progress Phases (Item 25) -->
                <div id="interview-progress" class="interview-progress">
                    <div class="progress-phases">
                        <div class="phase active" data-phase="intro">
                            <div class="phase-icon">ğŸ‘‹</div>
                            <span>Introduction</span>
                        </div>
                        <div class="phase" data-phase="narrative">
                            <div class="phase-icon">ğŸ“</div>
                            <span>Free Narrative</span>
                        </div>
                        <div class="phase" data-phase="details">
                            <div class="phase-icon">ğŸ”</div>
                            <span>Specific Details</span>
                        </div>
                        <div class="phase" data-phase="review">
                            <div class="phase-icon">âœ…</div>
                            <span>Review</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="interview-progress-fill" style="width: 10%"></div>
                    </div>
                </div>

                <!-- Interview Comfort Panel -->
                <div id="interview-comfort-panel" class="interview-comfort-panel">
                    <div class="comfort-controls">
                        <button id="comfort-pause-btn" class="comfort-btn" title="Pause interview" aria-label="Pause interview">
                            â¸ï¸ Pause
                        </button>
                        <button id="comfort-break-btn" class="comfort-btn" title="Take a 5-minute break" aria-label="Take a break">
                            â˜• Take Break
                        </button>
                        <button id="comfort-support-btn" class="comfort-btn" title="Get encouragement" aria-label="Get support">
                            ğŸ’š Support
                        </button>
                    </div>
                    <div class="interview-duration">
                        <span>â±ï¸ Duration:</span>
                        <span id="interview-duration-display" class="interview-duration-display">0:00</span>
                        <div class="breaks-counter">
                            <span>â˜•</span>
                            <span class="count" id="breaks-count">0</span>
                        </div>
                    </div>
                </div>

                <!-- Mobile Call Header -->
                <div id="mobile-call-header" class="mobile-call-header" role="region" aria-label="Officer Ray call status">
                    <div class="mobile-call-header-main">
                        <div>
                            <h3 class="mobile-call-title">ğŸ“ Officer Ray</h3>
                            <div class="mobile-call-chips">
                                <span id="mobile-call-state-chip" class="mobile-call-chip state-ready" aria-live="polite">Ready</span>
                                <span id="mobile-call-speaker-chip" class="mobile-call-chip" aria-live="polite">Speaker on</span>
                                <span id="mobile-call-autolisten-chip" class="mobile-call-chip" aria-live="polite">Auto-listen on</span>
                            </div>
                        </div>
                        <button id="mobile-call-help-btn" type="button" class="mobile-call-help-btn" aria-label="Open voice call help">
                            â“
                        </button>
                    </div>
                    <div class="mobile-call-meta">
                        <span class="mobile-call-elapsed-label">Elapsed</span>
                        <span id="mobile-call-elapsed" class="mobile-call-elapsed" aria-live="polite">00:00</span>
                        <span id="ray-listening-cue" class="ray-listening-cue hidden" aria-live="polite">Ray is listening</span>
                    </div>
                </div>

                <!-- Scene Preview Panel (Item 24) -->
                <div id="scene-preview-panel" class="scene-preview" style="display:none;" role="complementary" aria-label="Scene reconstruction preview">
                    <div class="scene-preview-header">
                        <h3>ğŸ” Scene Reconstruction</h3>
                        <span class="scene-preview-badge">Live</span>
                        <button onclick="toggleScenePreview()" class="scene-preview-toggle" aria-label="Toggle scene preview">â–¼</button>
                    </div>
                    <div class="scene-preview-content">
                        <img id="scene-preview-image" src="" alt="Scene reconstruction preview">
                        <div id="scene-elements-count">0 elements detected</div>
                    </div>
                </div>

                <!-- Mobile Scene Preview Strip (visible only on mobile when scene available) -->
                <div id="mobile-scene-strip" class="mobile-scene-strip" aria-label="Scene preview">
                    <img id="mobile-scene-strip-img" src="" alt="Scene reconstruction" class="mobile-scene-strip-img">
                    <div class="mobile-scene-strip-overlay">
                        <div class="mobile-scene-strip-copy">
                            <div class="mobile-scene-strip-title-row">
                                <span class="mobile-scene-strip-label">Scene reconstruction</span>
                                <span id="mobile-scene-update-indicator" class="scene-update-indicator hidden" aria-label="New scene update available"></span>
                            </div>
                            <span id="mobile-scene-strip-subtitle" class="mobile-scene-strip-subtitle">Waiting for your first scene update</span>
                        </div>
                        <span class="mobile-scene-strip-expand">â¤¢</span>
                    </div>
                </div>

                <!-- Quick Phrase Rail -->
                <div id="quick-phrase-rail" class="quick-phrase-rail" aria-label="Quick phrase shortcuts">
                    <button type="button" class="quick-phrase-chip" data-phrase="I saw a red car speeding away." aria-label="Send quick phrase red car speeding away">ğŸš— Red car sped away</button>
                    <button type="button" class="quick-phrase-chip" data-phrase="It happened near the entrance." aria-label="Send quick phrase near entrance">ğŸ“ Near the entrance</button>
                    <button type="button" class="quick-phrase-chip" data-phrase="I heard shouting before the impact." aria-label="Send quick phrase heard shouting">ğŸ—£ï¸ Heard shouting</button>
                    <button type="button" class="quick-phrase-chip" data-phrase="I can describe the person's clothing." aria-label="Send quick phrase describe clothing">ğŸ‘• Clothing details</button>
                    <button type="button" class="quick-phrase-chip" data-phrase="I noticed the license plate started with..." aria-label="Send quick phrase license plate">ğŸ”¢ License plate info</button>
                    <button type="button" class="quick-phrase-chip" data-phrase="I need to correct one detail." aria-label="Send quick phrase correct detail">âœï¸ Need a correction</button>
                </div>

                <!-- Chat transcript -->
                <div id="chat-transcript" class="chat-transcript" role="log" aria-live="polite" aria-label="Interview conversation">
                    <p class="empty-state">Tap the big mic below and talk naturally with Officer Ray. You can also use quick phrases, then add typed details anytime.</p>
                </div>

                <!-- Typing indicator -->
                <div class="typing-indicator hidden" id="typing-indicator">
                    <span class="typing-avatar">AI</span>
                    <div class="typing-dots">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>

                <div id="tap-interrupt-affordance" class="tap-interrupt-affordance hidden" aria-live="polite">
                    <span>Officer Ray is speaking â€” jump in anytime.</span>
                    <button id="tap-interrupt-btn" type="button" class="btn btn-secondary" aria-label="Interrupt Officer Ray and start talking">Tap to interrupt</button>
                </div>

                <!-- Suggested Actions -->
                <div class="suggested-actions" id="suggested-actions">
                    <button class="suggestion-btn" data-action="correct" aria-label="Correct something">âœï¸ Correct something</button>
                    <button class="suggestion-btn" data-action="generate" aria-label="Generate scene">ğŸ¬ Generate scene</button>
                    <button class="suggestion-btn" data-action="details" aria-label="Add more details">â• Add more details</button>
                </div>
                <!-- Guided Mode Suggestions -->
                <div id="guided-suggestions" style="display:none;"></div>
                <!-- Mode Toggles -->
                <div class="mode-toggles" id="mode-toggles">
                    <button class="mode-toggle-btn" id="guided-mode-btn" aria-label="Toggle guided interview mode">ğŸ“‹ Guided</button>
                    <button class="mode-toggle-btn" id="child-mode-btn" aria-label="Toggle child-friendly mode">ğŸ§’ Child Mode</button>
                    <button class="mode-toggle-btn" id="high-contrast-btn" aria-label="Toggle high contrast mode">ğŸ”² High Contrast</button>
                </div>

                <!-- Voice Control - always visible, voice-first -->
                <div class="voice-first-label">Voice-first â€” click mic or type below</div>
                <div class="controls expanded" id="voice-controls">
                    <!-- VAD Controls -->
                    <div class="vad-controls" id="vad-controls">
                        <div class="vad-toggle-row">
                            <label class="toggle-switch">
                                <input type="checkbox" id="vad-enabled" aria-label="Enable voice activity detection">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="vad-label">Auto-detect voice</span>
                            <div class="vad-indicator" id="vad-indicator" title="Voice activity indicator">
                                <span class="vad-dot"></span>
                            </div>
                        </div>
                        <div class="vad-settings hidden" id="vad-settings">
                            <div class="vad-setting">
                                <label for="vad-sensitivity">Sensitivity</label>
                                <input type="range" id="vad-sensitivity" min="0.005" max="0.05" step="0.001" value="0.015">
                                <span class="vad-value" id="vad-sensitivity-value">Medium</span>
                            </div>
                            <div class="vad-setting">
                                <label for="vad-silence">Silence timeout</label>
                                <input type="range" id="vad-silence" min="1" max="5" step="0.5" value="2">
                                <span class="vad-value" id="vad-silence-value">2.0s</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mic-container">
                        <!-- Animated pulse rings -->
                        <div class="mic-pulse-ring mic-pulse-ring-1"></div>
                        <div class="mic-pulse-ring mic-pulse-ring-2"></div>
                        <div class="mic-pulse-ring mic-pulse-ring-3"></div>
                        <!-- Sound wave rings (visible when recording) -->
                        <div class="mic-wave-ring mic-wave-ring-1"></div>
                        <div class="mic-wave-ring mic-wave-ring-2"></div>
                        <div class="mic-wave-ring mic-wave-ring-3"></div>
                        <div class="waveform-ring" id="waveform-ring"></div>
                        <canvas id="audio-visualizer" width="160" height="160"></canvas>
                        <button id="mic-btn" class="mic-btn connecting" disabled aria-label="Record voice message">
                            <span class="mic-icon">ğŸ¤</span>
                            <span class="btn-text">Connecting...</span>
                            <span class="mic-status-hint" id="mic-status-hint">Setting up session</span>
                        </button>
                    </div>
                    <div class="status-indicator" id="status-indicator">
                        <span id="status-text">Ready to listen</span>
                    </div>
                    
                    <!-- Audio Quality Indicator -->
                    <div id="audio-quality-container" class="audio-quality-container"></div>
                </div>

                <div id="voice-dock" class="voice-dock" role="region" aria-label="Voice quick controls">
                    <button id="voice-dock-mic-btn" type="button" class="voice-dock-mic-btn" aria-label="Start or stop voice recording">
                        <span class="voice-dock-mic-icon" aria-hidden="true">ğŸ¤</span>
                        <span id="voice-dock-mic-text" class="voice-dock-mic-text">Tap to talk</span>
                    </button>
                    <div class="voice-dock-actions">
                        <button id="dock-repeat-btn" type="button" class="voice-dock-action-btn" aria-label="Ask Officer Ray to repeat the question">ğŸ” Repeat</button>
                        <button id="dock-slow-btn" type="button" class="voice-dock-action-btn" aria-label="Ask Officer Ray to slow down">ğŸ¢ Slow down</button>
                        <button id="dock-moment-btn" type="button" class="voice-dock-action-btn" aria-label="Pause auto listen and take a moment">â¸ Need a moment</button>
                        <button id="dock-more-btn" type="button" class="voice-dock-action-btn voice-dock-more-btn" aria-label="Show more voice controls" aria-expanded="false">â‹¯ More</button>
                    </div>
                    <div id="voice-dock-more-panel" class="voice-dock-more-panel hidden">
                        <button id="dock-repeat-more-btn" type="button" class="voice-dock-action-btn" aria-label="Ask Officer Ray to repeat the question">ğŸ” Repeat</button>
                        <button id="dock-slow-more-btn" type="button" class="voice-dock-action-btn" aria-label="Ask Officer Ray to slow down">ğŸ¢ Slow down</button>
                        <button id="dock-moment-more-btn" type="button" class="voice-dock-action-btn" aria-label="Pause auto listen and take a moment">â¸ Need a moment</button>
                        <button id="dock-help-btn" type="button" class="voice-dock-action-btn" aria-label="Open voice help sheet">â“ Voice help</button>
                        <button id="dock-auto-btn" type="button" class="voice-dock-action-btn" aria-label="Toggle auto listen mode">ğŸ” Auto-listen</button>
                        <button id="dock-audio-toggle-btn" type="button" class="voice-dock-action-btn" aria-label="Disable or enable automatic audio playback" aria-pressed="false">ğŸ”Š Audio on</button>
                        <div class="voice-speed-group" role="group" aria-label="Officer Ray speaking speed">
                            <span class="voice-speed-label">Ray speed</span>
                            <button id="dock-speed-09-btn" type="button" class="voice-dock-action-btn voice-speed-btn" aria-label="Set speech speed to point nine">0.9x</button>
                            <button id="dock-speed-10-btn" type="button" class="voice-dock-action-btn voice-speed-btn is-active" aria-label="Set speech speed to one">1.0x</button>
                            <button id="dock-speed-11-btn" type="button" class="voice-dock-action-btn voice-speed-btn" aria-label="Set speech speed to one point one">1.1x</button>
                        </div>
                    </div>
                </div>

                <!-- Text Input â€” collapsed bar, expandable (secondary to voice) -->
                <div class="text-input text-input-collapsed" id="text-input-bar">
                    <button id="chat-mic-btn" class="btn btn-mic" disabled aria-label="Record voice" title="Hold to record" style="display:none;">ğŸ¤</button>
                    <!-- Language Selector for Translation -->
                    <select id="language-selector" class="language-selector" aria-label="Select your language" title="Select your language">
                        <option value="en">ğŸ‡ºğŸ‡¸ English</option>
                        <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
                        <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡</option>
                        <option value="vi">ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t</option>
                        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                        <option value="tl">ğŸ‡µğŸ‡­ Tagalog</option>
                        <option value="ar">ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
                        <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
                        <option value="de">ğŸ‡©ğŸ‡ª Deutsch</option>
                        <option value="pt">ğŸ‡§ğŸ‡· PortuguÃªs</option>
                        <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</option>
                        <option value="hi">ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€</option>
                        <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
                        <option value="pl">ğŸ‡µğŸ‡± Polski</option>
                        <option value="uk">ğŸ‡ºğŸ‡¦ Ğ£ĞºÑ€Ğ°Ñ—Ğ½ÑÑŒĞºĞ°</option>
                        <option value="fa">ğŸ‡®ğŸ‡· ÙØ§Ø±Ø³ÛŒ</option>
                        <option value="th">ğŸ‡¹ğŸ‡­ à¹„à¸—à¸¢</option>
                        <option value="he">ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª</option>
                    </select>
                    <button id="upload-evidence-btn" class="evidence-upload-btn" onclick="uploadEvidence()" aria-label="Attach photo evidence" title="Attach photo">
                        ğŸ“
                    </button>
                    <button id="upload-sketch-btn" class="evidence-upload-btn" onclick="uploadSketch()" aria-label="Upload hand-drawn sketch" title="Upload Sketch">
                        âœï¸
                    </button>
                    <button id="camera-btn" class="btn btn-secondary" title="Take Photo" aria-label="Take photo" onclick="document.getElementById('camera-input').click()">ğŸ“¸</button>
                    <input type="file" id="camera-input" accept="image/*,video/*" capture="environment" style="display:none;" onchange="window.app?.handlePhotoUpload(event)">
                    <input type="file" id="evidence-file-input" accept="image/*" style="display:none" onchange="handleEvidenceUpload(event)" aria-hidden="true">
                    <input type="file" id="sketch-file-input" accept="image/*" style="display:none" onchange="handleSketchUpload(event)" aria-hidden="true">
                    <button class="text-input-expand-btn" id="text-input-expand-btn" aria-label="Type a message" title="Or type instead...">âŒ¨ï¸ Type instead...</button>
                    <input type="text" id="text-input" placeholder="Describe what you witnessed..." disabled aria-label="Type your statement">
                    <span id="text-char-counter" class="text-char-counter" aria-live="polite">0 chars</span>
                    <button id="send-btn" class="btn btn-primary" disabled aria-label="Send message">Send</button>
                    <button id="retry-last-btn" class="btn btn-secondary" disabled aria-label="Retry last message" title="Retry last message">â†»</button>
                    <button id="auto-scroll-toggle" class="btn btn-secondary" aria-label="Toggle auto-scroll" title="Auto-scroll on" aria-pressed="true">â‡£</button>
                    <button id="compact-mode-toggle" class="btn btn-secondary" aria-label="Toggle compact mode" title="Toggle compact mode" aria-pressed="false">â–¤</button>
                    <button id="review-testimony-btn" class="btn btn-secondary review-testimony-btn" onclick="showTestimonySummary()" aria-label="Review testimony summary" title="Review Testimony" style="display:none;">
                        ğŸ“‹
                    </button>
                </div>

                <div class="keyboard-hint">
                    Press <kbd>Space</kbd> to record Â· <kbd>Esc</kbd> to cancel Â· Enable <em>Auto-detect voice</em> for hands-free
                </div>
            </section>

            <!-- RIGHT COLUMN: Secondary - Scene & Timeline -->
            <aside class="scene-panel" role="complementary">
                <!-- Scene Stats -->
                <div class="scene-stats" id="progress-tracker">
                    <div class="stat-card"><div class="stat-value" id="version-count">0</div><div class="stat-label">Versions</div></div>
                    <div class="stat-card"><div class="stat-value" id="statement-count">0</div><div class="stat-label">Statements</div></div>
                    <div class="stat-card"><div class="stat-value" id="session-duration">0m</div><div class="stat-label">Duration</div></div>
                    <div class="stat-card" id="complexity-card" style="display:none;"><div class="stat-value" id="complexity-score">--</div><div class="stat-label">Complexity</div></div>
                    <div class="stat-card warning" id="contradiction-card" style="display:none;"><div class="stat-value" id="contradiction-count">0</div><div class="stat-label">Contradictions</div></div>
                </div>

                <!-- Investigation Progress -->
                <div class="investigation-progress" id="investigation-progress">
                    <div class="progress-header">
                        <span class="progress-title">Report Completeness</span>
                        <span class="progress-pct" id="progress-pct">0%</span>
                    </div>
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill" id="progress-bar-fill" style="width:0%"></div>
                    </div>
                    <ul class="progress-checklist" id="progress-checklist">
                        <li data-cat="location"><span class="check-icon">â¬œ</span> ğŸ“ Location identified</li>
                        <li data-cat="people"><span class="check-icon">â¬œ</span> ğŸ‘¥ People described</li>
                        <li data-cat="vehicles"><span class="check-icon">â¬œ</span> ğŸš— Vehicles noted</li>
                        <li data-cat="timeline"><span class="check-icon">â¬œ</span> â±ï¸ Timeline established</li>
                        <li data-cat="evidence"><span class="check-icon">â¬œ</span> ğŸ” Evidence collected</li>
                    </ul>
                </div>

                <!-- Scene Display -->
                <h3 class="section-title">Scene Reconstruction</h3>
                <div id="scene-display" class="scene-display" role="img" aria-label="Reconstructed scene">
                    <div class="placeholder">
                        <div class="placeholder-icon">ğŸ“·</div>
                        <p>Scene will be generated as you describe the incident</p>
                        <p class="placeholder-hint">Start by telling us what happened â€” speak or type below</p>
                    </div>
                    <div class="scene-controls hidden">
                        <button class="scene-control-btn" id="zoom-btn" data-tooltip="Zoom" aria-label="Zoom scene">ğŸ”</button>
                        <button class="scene-control-btn" id="measure-btn" data-tooltip="Measure" aria-label="Measurement tools">ğŸ“</button>
                        <button class="scene-control-btn" id="download-btn" data-tooltip="Download" aria-label="Download scene">â¬‡ï¸</button>
                        <button class="scene-control-btn" id="fullscreen-btn" data-tooltip="Fullscreen" aria-label="Fullscreen">â›¶</button>
                        <button class="scene-control-btn" id="compare-btn" data-tooltip="Compare versions" aria-label="Compare versions">ğŸ”€</button>
                    </div>
                </div>
                <div id="scene-description" class="scene-description"><p>No scene generated yet</p></div>

                <!-- Witness Sketches Gallery -->
                <div class="witness-sketches-panel" id="witness-sketches-panel" style="display:none;">
                    <div class="sketches-header">
                        <h4>âœï¸ Witness Sketches</h4>
                        <span class="sketches-count" id="sketches-count">0</span>
                    </div>
                    <div class="sketches-gallery" id="sketches-gallery">
                        <p class="empty-state">No sketches uploaded yet. Use the âœï¸ button to upload hand-drawn sketches.</p>
                    </div>
                </div>

                <!-- Environmental Conditions Panel -->
                <div class="environmental-conditions-panel" id="environmental-conditions-panel">
                    <div class="conditions-header">
                        <h4>ğŸŒ¤ï¸ Environmental Conditions</h4>
                        <button class="conditions-toggle-btn" onclick="toggleConditionsPanel()" title="Toggle conditions">â–¼</button>
                    </div>
                    <div class="conditions-content collapsed" id="conditions-content">
                        <div class="condition-row">
                            <label for="weather-select">
                                <span class="condition-icon">â˜ï¸</span> Weather
                            </label>
                            <select id="weather-select" class="condition-select" onchange="updateEnvironmentalConditions()">
                                <option value="clear" data-icon="â˜€ï¸">Clear</option>
                                <option value="rain" data-icon="ğŸŒ§ï¸">Rain</option>
                                <option value="snow" data-icon="â„ï¸">Snow</option>
                                <option value="fog" data-icon="ğŸŒ«ï¸">Fog</option>
                            </select>
                        </div>
                        <div class="condition-row">
                            <label for="lighting-select">
                                <span class="condition-icon">ğŸ’¡</span> Lighting
                            </label>
                            <select id="lighting-select" class="condition-select" onchange="updateEnvironmentalConditions()">
                                <option value="daylight" data-icon="ğŸŒ">Daylight</option>
                                <option value="dusk" data-icon="ğŸŒ…">Dusk</option>
                                <option value="night" data-icon="ğŸŒ™">Night</option>
                                <option value="artificial" data-icon="ğŸ’¡">Artificial</option>
                            </select>
                        </div>
                        <div class="condition-row">
                            <label for="visibility-select">
                                <span class="condition-icon">ğŸ‘ï¸</span> Visibility
                            </label>
                            <select id="visibility-select" class="condition-select" onchange="updateEnvironmentalConditions()">
                                <option value="good" data-icon="âœ…">Good</option>
                                <option value="moderate" data-icon="âš ï¸">Moderate</option>
                                <option value="poor" data-icon="âŒ">Poor</option>
                            </select>
                        </div>
                        <div class="conditions-preview" id="conditions-preview">
                            <span class="preview-label">Preview:</span>
                            <span class="preview-icons" id="preview-icons">â˜€ï¸ ğŸŒ âœ…</span>
                        </div>
                    </div>
                </div>

                <!-- Scene Element Library & Editor -->
                <div class="scene-editor-container" id="scene-editor-container">
                    <div class="element-palette-header">
                        <h4>ğŸ¨ Scene Elements</h4>
                        <div class="palette-header-controls">
                            <div class="view-toggle-group">
                                <button class="view-toggle-btn active" id="view-2d-btn" onclick="toggleSceneView('2d')" title="2D View">2D</button>
                                <button class="view-toggle-btn" id="view-3d-btn" onclick="toggleSceneView('3d')" title="3D View">3D</button>
                                <button id="aerial-view-btn" class="btn btn-sm btn-secondary" onclick="toggleAerialView()" title="Bird's eye diagram">ğŸ—ºï¸ Diagram</button>
                            </div>
                            <div class="perspective-toggle-group" id="perspective-toggle-group">
                                <button class="perspective-toggle-btn active" id="view-bird-btn" onclick="togglePerspective('bird')" title="Bird's Eye View">ğŸ¦…</button>
                                <button class="perspective-toggle-btn" id="view-street-btn" onclick="togglePerspective('street')" title="Street Level View">ğŸš¶</button>
                            </div>
                            <button class="template-selector-btn" onclick="sceneTemplateManager.showTemplateSelector()" title="Choose Template">ğŸ“ Templates</button>
                            <button class="palette-toggle-btn" onclick="sceneElementLibrary.togglePalette()" title="Toggle palette">â–¼</button>
                        </div>
                    </div>
                    <div id="scene-element-palette" class="scene-element-palette collapsed">
                        <!-- Populated by scene-elements.js -->
                    </div>
                    <div id="scene-editor-canvas" class="show-grid" style="height: 350px;">
                        <div class="placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                            <span style="font-size: 2rem;">ğŸ¯</span>
                            <p style="margin-top: 8px; font-size: 0.85rem;">Drag elements here or click to place</p>
                        </div>
                    </div>
                    <div id="scene-3d-canvas" class="scene-3d-canvas" style="height: 350px; display: none;">
                        <!-- 3D viewer rendered here -->
                    </div>
                    <div id="scene-3d-controls" class="scene-3d-controls" style="display: none;">
                        <button class="scene-3d-btn" onclick="scene3DViewer.resetCamera()" title="Reset Camera">ğŸ </button>
                        <button class="scene-3d-btn" onclick="scene3DViewer.toggleGrid()" title="Toggle Grid">ğŸ”²</button>
                        <button class="scene-3d-btn" onclick="scene3DViewer.syncFromLibrary()" title="Sync from 2D">ğŸ”„</button>
                    </div>
                    <!-- Scene Animation Controls -->
                    <div id="scene-animation-container" class="scene-animation-container" style="display: none;">
                        <!-- Populated by scene-animation.js -->
                    </div>
                </div>

                <!-- Evidence Board -->
                <div class="evidence-board" id="evidence-board">
                    <h3 class="evidence-title">Evidence Board</h3>
                    <div class="evidence-cards" id="evidence-cards">
                        <p class="empty-state">Evidence will appear as you describe the scene</p>
                    </div>
                    <div class="evidence-timeline" id="evidence-timeline" style="display:none;">
                        <h4>Event Timeline</h4>
                        <div class="timeline-events" id="timeline-events"></div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="timeline-panel" role="complementary" aria-label="Scene version timeline">
                    <h3>Version History</h3>
                    <div id="timeline" class="timeline">
                        <p class="empty-state">No versions yet</p>
                    </div>
                </div>

                <!-- Export Controls -->
                <div class="export-controls" id="export-controls" style="display:none;">
                    <h4>Export Report</h4>
                    <div class="export-buttons">
                        <button class="btn btn-secondary btn-export" id="export-pdf-btn">ğŸ“„ PDF Report</button>
                        <button class="btn btn-secondary btn-export" id="export-json-btn">ğŸ“¦ JSON Data</button>
                        <button class="btn btn-secondary btn-export" id="export-evidence-btn" data-tooltip="Law enforcement evidence report">ğŸ”’ Evidence Report</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Template Selector Modal -->
    <div id="template-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="template-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="template-modal-title">ğŸ“‹ What type of incident are you reporting?</h2>
                <button class="modal-close" id="close-template-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <p class="modal-description">Select the type of incident to help guide the interview with relevant questions.</p>
            <div id="template-grid" class="template-grid">
                <p class="empty-state">Loading templates...</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="skip-template-btn">Skip - General Report</button>
            </div>
        </div>
    </div>

    <!-- Session List Modal -->
    <div id="session-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Your Sessions</h2>
                <button class="modal-close" id="close-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <div id="session-list" class="session-list">
                <p class="empty-state">Loading sessions...</p>
            </div>
            <button class="btn btn-secondary" id="modal-close-btn-2">Close</button>
        </div>
    </div>

    <!-- Model & Quota Modal -->
    <div id="quota-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="quota-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="quota-modal-title">ğŸ¤– Gemini Model & Quota</h2>
                <button class="modal-close" id="close-quota-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <!-- Model Selector -->
            <div class="model-selector-section">
                <h3>Active Model</h3>
                <div class="model-select-group">
                    <div class="model-select-wrapper">
                        <select id="model-select" class="model-select" aria-label="Select Gemini model">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                    <button id="apply-model-btn" class="btn btn-primary" disabled>Apply</button>
                </div>
                <p class="model-help-text">
                    ğŸ’¡ Free tier recommended: <strong>gemini-2.5-flash</strong> (15 RPM, 15M tokens/day)
                </p>
            </div>

            <!-- Quota Dashboard -->
            <div class="quota-dashboard">
                <h3>Usage & Quota</h3>
                
                <div class="quota-grid">
                    <!-- Requests Per Minute -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Requests / Minute</h4>
                            <span class="quota-badge" id="rpm-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="rpm-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="rpm-used">0</span> / <span id="rpm-limit">--</span> requests
                        </p>
                    </div>

                    <!-- Requests Per Day -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Requests / Day</h4>
                            <span class="quota-badge" id="rpd-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="rpd-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="rpd-used">0</span> / <span id="rpd-limit">--</span> requests
                        </p>
                    </div>

                    <!-- Tokens Per Day -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Tokens / Day</h4>
                            <span class="quota-badge" id="tpd-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="tpd-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="tpd-used">0</span> / <span id="tpd-limit">--</span> tokens
                        </p>
                    </div>
                </div>

                <div class="quota-footer">
                    <p class="quota-disclaimer">
                        âš ï¸ <strong>Local tracking</strong>: Gemini API does not provide programmatic quota endpoints. 
                        Usage is tracked locally and resets at midnight UTC. Counts are approximate.
                    </p>
                    <button id="refresh-quota-btn" class="btn btn-secondary">ğŸ”„ Refresh</button>
                </div>
            </div>

            <button class="btn btn-secondary" id="modal-close-quota-btn-2">Close</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="analytics-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="analytics-modal-title">ğŸ“Š Session Analytics</h2>
                <button class="modal-close" id="close-analytics-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="analytics-dashboard">
                <h3>Overall Statistics</h3>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-icon">ğŸ“</div>
                        <div class="analytics-value" id="analytics-total-sessions">--</div>
                        <div class="analytics-label">Total Sessions</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">ğŸ¬</div>
                        <div class="analytics-value" id="analytics-active-sessions">--</div>
                        <div class="analytics-label">Active Sessions</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">ğŸ–¼ï¸</div>
                        <div class="analytics-value" id="analytics-total-scenes">--</div>
                        <div class="analytics-label">Scenes Generated</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">â±ï¸</div>
                        <div class="analytics-value" id="analytics-avg-duration">--</div>
                        <div class="analytics-label">Avg Session Time</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 2rem;">Element Insights</h3>
                <div class="element-insights">
                    <div class="insight-row">
                        <span class="insight-label">Most Common Elements:</span>
                        <span class="insight-value" id="analytics-top-elements">--</span>
                    </div>
                    <div class="insight-row">
                        <span class="insight-label">Average Confidence:</span>
                        <span class="insight-value" id="analytics-avg-confidence">--</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-close-analytics-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Server Info Modal -->
    <div id="info-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="info-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="info-modal-title">â„¹ï¸ Server Information</h2>
                <button class="modal-close" id="close-info-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="server-info-panel">
                <div class="info-section">
                    <h4>System Status</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-key">Version:</span>
                            <span class="info-value" id="info-version">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Environment:</span>
                            <span class="info-value" id="info-env">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Python:</span>
                            <span class="info-value" id="info-python">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Debug Mode:</span>
                            <span class="info-value" id="info-debug">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>Available Features</h4>
                    <div class="feature-badges" id="feature-badges">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>Configuration</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-key">Active Model:</span>
                            <span class="info-value" id="info-model">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Rate Limiting:</span>
                            <span class="info-value" id="info-rate-limit">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-close-info-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div id="onboarding-overlay" class="onboarding-overlay hidden" role="dialog" aria-modal="true" aria-label="Welcome onboarding">
        <div class="onboarding-content">
            <!-- Step 1 -->
            <div class="onboarding-step active" data-step="1">
                <div class="onboarding-icon">ğŸš¨</div>
                <h2>Welcome to WitnessReplay</h2>
                <p>We're here to help you <strong>report an incident</strong> â€” whether it's an accident, crime, or any event you witnessed. You can speak or type, and we'll guide you through the process.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" id="skip-onboarding">Skip</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next â¤</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 2 -->
            <div class="onboarding-step" data-step="2">
                <div class="onboarding-icon">ğŸ¤</div>
                <h2>Speak or Type</h2>
                <p>Describe what you saw in your own words. Click the microphone or press <kbd>Space</kbd> to start recording, or simply type in the chat. We'll listen carefully and begin building a record of the incident.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">â¬… Back</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next â¤</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 3 -->
            <div class="onboarding-step" data-step="3">
                <div class="onboarding-icon">ğŸ’¬</div>
                <h2>Guided Reporting</h2>
                <p>We'll ask clarifying questions to capture the full picture. Answer naturally. If something needs correcting, just say so â€” "The car was blue, not red" â€” and we'll update the record immediately.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">â¬… Back</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next â¤</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 4 -->
            <div class="onboarding-step" data-step="4">
                <div class="onboarding-icon">âœ…</div>
                <h2>Ready to Report</h2>
                <p>Your report is saved automatically. You can review the timeline, scene reconstruction, export to PDF, or start a new report anytime. Let's document what you witnessed.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">â¬… Back</button>
                    <button class="btn btn-success" id="start-session-btn">Start Report â¤</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>

    <!-- Witness Information Form (Item 27) -->
    <div id="witness-info-overlay" class="witness-info-overlay" style="display:none;" role="dialog" aria-modal="true" aria-label="Witness information form">
        <div class="witness-form">
            <h3>Witness Information <span class="optional-badge">Optional</span></h3>
            <p class="form-note">This information helps officers follow up. You may remain anonymous.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="witness-name">Name</label>
                    <input type="text" id="witness-name" placeholder="Your name (optional)" aria-label="Witness name">
                </div>
                <div class="form-group">
                    <label for="witness-contact">Contact</label>
                    <input type="text" id="witness-contact" placeholder="Phone or email (optional)" aria-label="Contact information">
                </div>
                <div class="form-group form-group-full anonymous-toggle-row">
                    <label class="anonymous-toggle" for="witness-anonymous-toggle">
                        <input type="checkbox" id="witness-anonymous-toggle" aria-label="Remain anonymous and clear name and contact">
                        <span>Remain anonymous (clear name and contact)</span>
                    </label>
                </div>
                <div class="form-group form-group-full">
                    <label for="witness-location">Location at time of incident</label>
                    <div class="location-input-wrapper">
                        <input type="text" id="witness-location" placeholder="Enter address or use GPS" aria-label="Location at time of incident" autocomplete="off">
                        <button type="button" id="gps-location-btn" class="gps-btn" title="Get current GPS location" aria-label="Get current location">
                            ğŸ“
                        </button>
                        <div id="location-suggestions" class="location-suggestions" role="listbox"></div>
                    </div>
                    <div id="location-coordinates" class="location-coordinates"></div>
                    <div id="location-map" class="location-map-container"></div>
                </div>
            </div>
            <div class="witness-form-actions">
                <button onclick="startInterview()" class="btn btn-primary">Begin Interview</button>
                <button onclick="skipInfo()" class="btn-text-link">Skip &amp; Start Anonymous Interview</button>
            </div>
        </div>
    </div>

    <!-- Testimony Summary Modal (Item 26) -->
    <div id="testimony-summary-modal" class="modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="testimony-summary-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="testimony-summary-title">ğŸ“‹ Testimony Summary</h2>
                <button class="modal-close" onclick="closeSummary()" aria-label="Close summary">&times;</button>
            </div>
            <div id="summary-content">
                <div class="summary-section">
                    <h3>Your Statements</h3>
                    <div id="summary-statements"></div>
                </div>
                <div class="summary-section">
                    <h3>Key Details Mentioned</h3>
                    <div id="summary-elements"></div>
                </div>
            </div>
            <div class="summary-actions">
                <button onclick="closeSummary()" class="btn btn-secondary">Continue Interview</button>
                <button onclick="submitTestimony()" class="btn btn-primary">Submit Testimony</button>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <button class="help-button" id="help-btn" data-tooltip="Help & Tutorial" aria-label="Help">
        ?
    </button>

    <!-- Scripts -->
    <script src="/static/js/audio-processor.js"></script>
    <script src="/static/js/audio.js"></script>
    <script src="/static/js/audio-quality.js"></script>
    <script src="/static/js/vad.js"></script>
    <script src="/static/js/ui.js"></script>
    <script src="/static/js/measurements.js" defer></script>
    <script src="/static/js/evidence-markers.js" defer></script>
    <script src="/static/js/scene-elements.js" defer></script>
    <script src="/static/js/scene-templates.js" defer></script>
    <script src="/static/js/scene-3d.js" defer></script>
    <script src="/static/js/scene-animation.js" defer></script>
    <script src="/static/js/location.js" defer></script>
    <script src="/static/js/interview-comfort.js" defer></script>
    <script src="/static/js/app.js"></script>
    
    <!-- Sync mobile menu duration + close on outside click -->
    <script>
        (function() {
            // Sync duration display to mobile menu
            const src = document.getElementById('interview-duration-display');
            const dst = document.getElementById('mobile-duration-display');
            if (src && dst) {
                new MutationObserver(function() { dst.textContent = src.textContent; })
                    .observe(src, { childList: true, characterData: true, subtree: true });
            }
            // Close mobile menu on outside click
            document.addEventListener('click', function(e) {
                const menu = document.getElementById('mobile-menu-dropdown');
                const overlay = document.getElementById('mobile-menu-overlay');
                const btn = document.getElementById('hamburger-menu-btn');
                if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                    menu.classList.remove('open');
                    if (overlay) overlay.classList.remove('open');
                }
            });
        })();
    </script>
    
    <!-- Initialize Scene Element Library and 3D Viewer -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.sceneElementLibrary) {
                window.sceneElementLibrary.init();
            }
            if (window.scene3DViewer) {
                window.scene3DViewer.init();
            }
        });
        
        // Toggle between 2D and 3D scene views
        let currentSceneView = '2d';
        let currentPerspective = 'bird';
        
        function toggleSceneView(view) {
            if (view === currentSceneView) return;
            currentSceneView = view;
            
            const canvas2d = document.getElementById('scene-editor-canvas');
            const canvas3d = document.getElementById('scene-3d-canvas');
            const controls3d = document.getElementById('scene-3d-controls');
            const btn2d = document.getElementById('view-2d-btn');
            const btn3d = document.getElementById('view-3d-btn');
            const palette = document.getElementById('scene-element-palette');
            const perspectiveGroup = document.getElementById('perspective-toggle-group');
            
            if (view === '3d') {
                // Switch to 3D
                canvas2d.style.display = 'none';
                canvas3d.style.display = 'block';
                controls3d.style.display = 'flex';
                palette.style.display = 'none';
                btn2d.classList.remove('active');
                btn3d.classList.add('active');
                // Hide perspective toggle in 3D view (3D has its own camera controls)
                if (perspectiveGroup) perspectiveGroup.style.display = 'none';
                
                if (window.scene3DViewer) {
                    window.scene3DViewer.activate(canvas3d);
                }
            } else {
                // Switch to 2D
                canvas2d.style.display = 'block';
                canvas3d.style.display = 'none';
                controls3d.style.display = 'none';
                palette.style.display = '';
                btn2d.classList.add('active');
                btn3d.classList.remove('active');
                // Show perspective toggle in 2D view
                if (perspectiveGroup) perspectiveGroup.style.display = 'flex';
                
                if (window.scene3DViewer) {
                    window.scene3DViewer.deactivate();
                }
            }
        }
        
        // Toggle between Bird's Eye and Street Level perspective
        function togglePerspective(perspective) {
            if (perspective === currentPerspective) return;
            currentPerspective = perspective;
            
            const canvas = document.getElementById('scene-editor-canvas');
            const btnBird = document.getElementById('view-bird-btn');
            const btnStreet = document.getElementById('view-street-btn');
            
            if (!canvas) return;
            
            // Remove all perspective classes
            canvas.classList.remove('perspective-bird', 'perspective-street');
            
            // Add the new perspective class
            canvas.classList.add(`perspective-${perspective}`);
            
            // Update button states
            btnBird.classList.toggle('active', perspective === 'bird');
            btnStreet.classList.toggle('active', perspective === 'street');
            
            console.log('[Scene] Perspective switched to:', perspective);
        }
    </script>
    
    <!-- Inline helper functions for onboarding -->
    <script>
        let currentOnboardingStep = 1;
        
        function nextOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            if (currentOnboardingStep < steps.length) {
                steps[currentOnboardingStep - 1].classList.remove('active');
                currentOnboardingStep++;
                steps[currentOnboardingStep - 1].classList.add('active');
            }
        }
        
        function prevOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            if (currentOnboardingStep > 1) {
                steps[currentOnboardingStep - 1].classList.remove('active');
                currentOnboardingStep--;
                steps[currentOnboardingStep - 1].classList.add('active');
            }
        }
        
        function closeOnboarding() {
            document.getElementById('onboarding-overlay').classList.add('hidden');
            localStorage.setItem('witnessreplay-onboarding-completed', 'true');
        }
        
        document.getElementById('skip-onboarding')?.addEventListener('click', closeOnboarding);
        document.getElementById('start-session-btn')?.addEventListener('click', closeOnboarding);
        
        // Voice-first: text input expand/collapse
        (function() {
            const bar = document.getElementById('text-input-bar');
            const expandBtn = document.getElementById('text-input-expand-btn');
            const textInput = document.getElementById('text-input');
            if (expandBtn && bar) {
                expandBtn.addEventListener('click', function() {
                    bar.classList.toggle('text-input-collapsed');
                    bar.classList.toggle('text-input-expanded');
                    if (bar.classList.contains('text-input-expanded') && textInput) {
                        textInput.focus();
                    }
                });
            }
            // Collapse when text input blurs and is empty
            if (textInput && bar) {
                textInput.addEventListener('blur', function() {
                    if (!textInput.value.trim()) {
                        setTimeout(function() {
                            bar.classList.add('text-input-collapsed');
                            bar.classList.remove('text-input-expanded');
                        }, 200);
                    }
                });
            }
        })();
        
        // Initialize app
        window.app = new WitnessReplayApp();

        // Anonymous tip mode: hide witness info popup if ?anonymous=true
        if (window.location.search.includes('anonymous=true')) {
            window._anonymousMode = true;
            const witnessOverlay = document.getElementById('witness-info-overlay');
            if (witnessOverlay) witnessOverlay.style.display = 'none';
        }
    </script>

    <!-- Comparison Modal -->
    <div id="comparison-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="comparison-modal-title">
        <div class="modal-content modal-fullwidth">
            <div class="modal-header">
                <h2 id="comparison-modal-title">ğŸ”€ Version Comparison</h2>
                <button class="modal-close" id="close-comparison-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <!-- Version selectors -->
            <div class="comparison-selectors">
                <div class="comparison-selector-group">
                    <label for="comparison-version-a">Compare:</label>
                    <select id="comparison-version-a" class="comparison-select">
                        <option value="">Select version...</option>
                    </select>
                </div>
                <span class="comparison-vs">vs</span>
                <div class="comparison-selector-group">
                    <label for="comparison-version-b">With:</label>
                    <select id="comparison-version-b" class="comparison-select">
                        <option value="">Select version...</option>
                    </select>
                </div>
                <button id="compare-versions-btn" class="btn btn-primary btn-sm">Compare</button>
            </div>
            <!-- Diff Summary -->
            <div id="comparison-diff-summary" class="comparison-diff-summary hidden">
                <div class="diff-badge diff-added"><span class="diff-count" id="diff-added-count">0</span> Added</div>
                <div class="diff-badge diff-removed"><span class="diff-count" id="diff-removed-count">0</span> Removed</div>
                <div class="diff-badge diff-changed"><span class="diff-count" id="diff-changed-count">0</span> Changed</div>
                <div class="diff-badge diff-unchanged"><span class="diff-count" id="diff-unchanged-count">0</span> Unchanged</div>
            </div>
            <div class="comparison-modal-body">
                <div class="comparison-panel">
                    <div class="comparison-header">
                        <span id="comparison-header-a">Version A</span>
                        <span class="comparison-timestamp" id="comparison-timestamp-a"></span>
                    </div>
                    <div id="comparison-before" class="comparison-image-container">
                        <!-- Before image inserted here -->
                    </div>
                    <div id="comparison-before-description" class="comparison-description">
                        <!-- Description -->
                    </div>
                    <div id="comparison-elements-a" class="comparison-elements">
                        <!-- Elements list -->
                    </div>
                </div>
                <div class="comparison-divider-vertical">
                    <div class="divider-handle">â‡„</div>
                </div>
                <div class="comparison-panel">
                    <div class="comparison-header">
                        <span id="comparison-header-b">Version B</span>
                        <span class="comparison-timestamp" id="comparison-timestamp-b"></span>
                    </div>
                    <div id="comparison-after" class="comparison-image-container">
                        <!-- After image inserted here -->
                    </div>
                    <div id="comparison-after-description" class="comparison-description">
                        <!-- Description -->
                    </div>
                    <div id="comparison-elements-b" class="comparison-elements">
                        <!-- Elements list -->
                    </div>
                </div>
            </div>
            <!-- Detailed changes panel -->
            <div id="comparison-changes-panel" class="comparison-changes-panel hidden">
                <h4>ğŸ” Detailed Changes</h4>
                <div id="comparison-changes-list" class="comparison-changes-list">
                    <!-- Changes rendered here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="toggle-comparison-mode-btn" data-tooltip="Toggle comparison mode in scene viewer">ğŸ“ Toggle Compare Mode</button>
                <button class="btn btn-secondary" id="modal-close-comparison-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Overlay -->
    <div id="shortcuts-overlay" class="shortcuts-overlay hidden" role="dialog" aria-modal="true" aria-label="Keyboard shortcuts">
        <div class="shortcuts-content">
            <h2>âŒ¨ï¸ Keyboard Shortcuts</h2>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <kbd>Space</kbd>
                    <span>Start/Stop recording</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Esc</kbd>
                    <span>Cancel recording / Close modal</span>
                </div>
                <div class="shortcut-item">
                    <kbd>?</kbd>
                    <span>Show this help</span>
                </div>
                <div class="shortcut-item">
                    <kbd>N</kbd>
                    <span>New session</span>
                </div>
                <div class="shortcut-item">
                    <kbd>S</kbd>
                    <span>Show sessions list</span>
                </div>
                <div class="shortcut-item">
                    <kbd>M</kbd>
                    <span>Open model selector</span>
                </div>
                <div class="shortcut-item">
                    <kbd>A</kbd>
                    <span>Show analytics</span>
                </div>
                <div class="shortcut-item">
                    <kbd>I</kbd>
                    <span>Server information</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="window.app.hideShortcuts()">Close</button>
        </div>
    </div>

    <div id="mobile-voice-help-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="mobile-voice-help-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="mobile-voice-help-title">ğŸ“± Voice call shortcuts</h2>
                <button id="mobile-voice-help-close-x" class="modal-close" aria-label="Close voice help">&times;</button>
            </div>
            <div class="modal-body mobile-voice-help-body">
                <p>Use these controls to keep the conversation natural with Officer Ray:</p>
                <ul>
                    <li><strong>ğŸ¤ Tap to talk</strong> â€” Start/stop recording quickly.</li>
                    <li><strong>ğŸ” Repeat</strong> â€” Ask Officer Ray to repeat the last question.</li>
                    <li><strong>ğŸ¢ Slow down</strong> â€” Request shorter, slower prompts.</li>
                    <li><strong>â¸ Need a moment</strong> â€” Pause auto-listen while you collect details.</li>
                    <li><strong>Tap to interrupt</strong> â€” Cut in while Ray is speaking.</li>
                </ul>
            </div>
            <div class="modal-actions">
                <button id="mobile-voice-help-close-btn" class="btn btn-secondary" type="button" aria-label="Close voice help sheet">Close</button>
            </div>
        </div>
    </div>

    <div id="mobile-voice-coachmark" class="mobile-voice-coachmark hidden" role="dialog" aria-modal="true" aria-labelledby="mobile-voice-coachmark-title">
        <div class="mobile-voice-coachmark-card">
            <h2 id="mobile-voice-coachmark-title">ğŸ™ï¸ Talk like a phone call</h2>
            <p>Tap <strong>Tap to talk</strong>, speak naturally, and use quick chips when you need speed.</p>
            <div class="mobile-voice-coachmark-actions">
                <button id="mobile-voice-coachmark-dismiss" type="button" class="btn btn-primary" aria-label="Dismiss mobile voice coaching tips">Got it</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Modal (First-Time Experience) -->
    <div id="onboarding-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="onboarding-title">
        <div class="modal-content modal-wide onboarding-modal">
            <div class="modal-header onboarding-header">
                <h2 id="onboarding-title">ğŸ‘‹ Welcome to WitnessReplay</h2>
            </div>
            
            <div class="onboarding-content onboarding-grid">
                <div class="onboarding-step">
                    <div class="onboarding-icon">ğŸ¤</div>
                    <h3>Speak or Type Your Account</h3>
                    <p>Describe what you witnessed naturally â€” use your voice or type. Our AI listens carefully to every detail.</p>
                </div>
                
                <div class="onboarding-step">
                    <div class="onboarding-icon">ğŸ›¡ï¸</div>
                    <h3>Detective Ray Guides You</h3>
                    <p>Our AI detective will ask follow-up questions to build a complete picture of the incident.</p>
                </div>
                
                <div class="onboarding-step">
                    <div class="onboarding-icon">ğŸ¬</div>
                    <h3>Visual Scene Reconstruction</h3>
                    <p>Watch as your account is reconstructed as a visual scene. Make corrections and add details anytime.</p>
                </div>
                
                <div class="onboarding-step">
                    <div class="onboarding-icon">ğŸ“‹</div>
                    <h3>Export Your Report</h3>
                    <p>Export complete incident reports with evidence boards, timelines, and scene reconstructions.</p>
                </div>            </div>
            
            <div class="onboarding-footer">
                <label class="onboarding-checkbox">
                    <input type="checkbox" id="dont-show-onboarding">
                    <span>Don't show this again</span>
                </label>
                <button class="btn btn-primary btn-lg" id="onboarding-start-btn">Get Started â†’</button>
            </div>
        </div>
    </div>

    <!-- Version Display -->
    <div class="version-badge" id="version-display">
        <span class="version-label">WitnessReplay</span>
        <span class="version-number">v2.0</span>
        <span class="version-separator">â€¢</span>
        <span class="version-challenge">Gemini Live Agent Challenge</span>
    </div>

    <!-- Digital Signature Modal -->
    <div id="signature-modal" class="modal" style="display:none;" role="dialog" aria-modal="true" aria-label="Sign your statement">
        <div class="modal-content" style="max-width:500px;">
            <h3>âœï¸ Sign Your Statement</h3>
            <p style="color:var(--text-secondary);font-size:0.85rem;">By signing, you confirm this statement is accurate to the best of your knowledge.</p>
            <canvas id="signature-canvas" width="460" height="200" style="border:1px solid var(--glass-border);border-radius:8px;background:rgba(255,255,255,0.05);cursor:crosshair;display:block;margin:12px 0;"></canvas>
            <div style="display:flex;gap:10px;">
                <button class="btn btn-secondary" onclick="clearSignature()">Clear</button>
                <button class="btn btn-primary" onclick="submitSignature()">Submit Signature</button>
                <button class="btn btn-secondary" onclick="document.getElementById('signature-modal').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>
    <script>
    function initSignatureCanvas() {
        const canvas = document.getElementById('signature-canvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        let drawing = false;
        canvas.addEventListener('mousedown', (e) => { drawing = true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
        canvas.addEventListener('mousemove', (e) => { if (!drawing) return; ctx.lineWidth = 2; ctx.strokeStyle = '#60a5fa'; ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); });
        canvas.addEventListener('mouseup', () => drawing = false);
        canvas.addEventListener('mouseleave', () => drawing = false);
        canvas.addEventListener('touchstart', (e) => { e.preventDefault(); drawing = true; const r = canvas.getBoundingClientRect(); ctx.beginPath(); ctx.moveTo(e.touches[0].clientX-r.left, e.touches[0].clientY-r.top); });
        canvas.addEventListener('touchmove', (e) => { e.preventDefault(); if (!drawing) return; const r = canvas.getBoundingClientRect(); ctx.lineWidth = 2; ctx.strokeStyle = '#60a5fa'; ctx.lineTo(e.touches[0].clientX-r.left, e.touches[0].clientY-r.top); ctx.stroke(); });
        canvas.addEventListener('touchend', () => drawing = false);
    }
    function clearSignature() { const c = document.getElementById('signature-canvas'); c?.getContext('2d').clearRect(0,0,c.width,c.height); }
    function submitSignature() {
        const canvas = document.getElementById('signature-canvas');
        const data = canvas.toDataURL('image/png');
        if (window.app?.ws?.readyState === WebSocket.OPEN) {
            window.app.ws.send(JSON.stringify({type:'signature', data:{image: data.split(',')[1]}}));
            window.app.displaySystemMessage('âœï¸ Statement signed successfully.');
        }
        document.getElementById('signature-modal').style.display = 'none';
    }
    document.addEventListener('DOMContentLoaded', initSignatureCanvas);
    </script>
    
    <!-- Particle Background Canvas -->
    <canvas id="particle-canvas" class="particle-canvas"></canvas>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/static/sw.js').catch(()=>{});
    navigator.serviceWorker.addEventListener('message', (e) => {
        if (e.data?.type === 'SW_UPDATED') {
            const banner = document.createElement('div');
            banner.className = 'update-banner';
            banner.innerHTML = 'ğŸ”„ A new version is available. <button onclick="location.reload()">Refresh</button>';
            banner.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#1e40af;color:#fff;padding:10px 16px;text-align:center;z-index:99999;font-size:0.9rem;display:flex;align-items:center;justify-content:center;gap:8px;';
            banner.querySelector('button').style.cssText = 'background:#fff;color:#1e40af;border:none;padding:4px 12px;border-radius:6px;font-weight:600;cursor:pointer;';
            document.body.appendChild(banner);
        }
    });
}
</script>
</body>
</html>
