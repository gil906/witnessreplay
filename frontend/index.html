<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WitnessReplay ‚Äî Professional incident reporting system. Report accidents and crimes by speaking or typing with an AI-guided interview.">
    <meta name="theme-color" content="#00d4ff">
    <title>WitnessReplay - Report an Incident</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üõ°Ô∏è</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/styles.css">
</head>
<body>
    <!-- Skip to content link (Accessibility) -->
    <a href="#chat-transcript" class="skip-to-content">Skip to main content</a>

    <!-- Main Container -->
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">üõ°Ô∏è</div>
                    <div class="logo-text">
                        <h1>WitnessReplay</h1>
                        <p class="tagline">AI-Powered Witness Interview &amp; Scene Reconstruction</p>
                        <p class="tagline-sub">Powered by Google Gemini ‚Ä¢ Built for Law Enforcement</p>
                    </div>
                    <span class="challenge-badge">Gemini Live Agent Challenge</span>
                </div>
                
                <div class="session-info">
                    <div class="connection-status" id="connection-status" title="Connection status">
                        <span class="status-dot"></span>
                        <span class="status-text">Connecting...</span>
                    </div>
                    <div class="session-status" style="display:none;">
                        <span class="status-dot"></span>
                        <span id="session-id">Initializing...</span>
                    </div>
                    <button id="new-session-btn" class="btn btn-secondary">
                        ‚ûï New Report
                    </button>
                    <!-- Hidden technical buttons (IDs preserved for app.js) -->
                    <button id="sessions-list-btn" class="btn btn-secondary" style="display:none;" data-tooltip="View all sessions">üìã Sessions</button>
                    <button id="quota-btn" class="btn btn-secondary" style="display:none;" data-tooltip="Model & Quota">ü§ñ Model</button>
                    <button id="analytics-btn" class="btn btn-secondary" style="display:none;" data-tooltip="View analytics">üìä Analytics</button>
                    <button id="info-btn" class="btn btn-secondary" style="display:none;" data-tooltip="Server info">‚ÑπÔ∏è Info</button>
                    <button id="theme-toggle" class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle dark/light theme" title="Toggle theme">
                        <span class="theme-icon">üåô</span>
                    </button>
                    <button id="admin-portal-btn" class="btn btn-primary" data-tooltip="Admin Portal">
                        üõ°Ô∏è Admin
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content: 2-Column Layout ‚Äî Chat Primary (left) | Scene Secondary (right) -->
        <div class="main-content" id="main-workspace">
            <!-- LEFT COLUMN: Primary - Chat & Voice -->
            <section class="chat-panel" role="main">
                <!-- Step indicator showing how reporting works -->
                <div class="reporting-steps">
                    <div class="step active"><span class="step-num">1</span> Describe Incident</div>
                    <div class="step"><span class="step-num">2</span> Answer Questions</div>
                    <div class="step"><span class="step-num">3</span> Review &amp; Export</div>
                </div>

                <!-- Multi-Witness Selector Bar -->
                <div id="witness-selector-bar" class="witness-selector-bar" style="display:none;">
                    <div class="witness-tabs" id="witness-tabs">
                        <!-- Witness tabs populated dynamically -->
                    </div>
                    <button id="add-witness-btn" class="btn btn-secondary btn-sm" title="Add another witness">
                        <span class="btn-icon">+</span> Add Witness
                    </button>
                </div>

                <!-- Interview Progress Phases (Item 25) -->
                <div id="interview-progress" class="interview-progress">
                    <div class="progress-phases">
                        <div class="phase active" data-phase="intro">
                            <div class="phase-icon">üëã</div>
                            <span>Introduction</span>
                        </div>
                        <div class="phase" data-phase="narrative">
                            <div class="phase-icon">üìù</div>
                            <span>Free Narrative</span>
                        </div>
                        <div class="phase" data-phase="details">
                            <div class="phase-icon">üîç</div>
                            <span>Specific Details</span>
                        </div>
                        <div class="phase" data-phase="review">
                            <div class="phase-icon">‚úÖ</div>
                            <span>Review</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="interview-progress-fill" style="width: 10%"></div>
                    </div>
                </div>

                <!-- Scene Preview Panel (Item 24) -->
                <div id="scene-preview-panel" class="scene-preview" style="display:none;" role="complementary" aria-label="Scene reconstruction preview">
                    <div class="scene-preview-header">
                        <h3>üîç Scene Reconstruction</h3>
                        <span class="scene-preview-badge">Live</span>
                        <button onclick="toggleScenePreview()" class="scene-preview-toggle" aria-label="Toggle scene preview">‚ñº</button>
                    </div>
                    <div class="scene-preview-content">
                        <img id="scene-preview-image" src="" alt="Scene reconstruction preview">
                        <div id="scene-elements-count">0 elements detected</div>
                    </div>
                </div>

                <!-- Chat transcript -->
                <div id="chat-transcript" class="chat-transcript" role="log" aria-live="polite" aria-label="Interview conversation">
                    <p class="empty-state">Your conversation will appear here. Start by describing what happened.</p>
                </div>

                <!-- Typing indicator -->
                <div class="typing-indicator hidden" id="typing-indicator">
                    <span class="typing-avatar">AI</span>
                    <div class="typing-dots">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>

                <!-- Suggested Actions -->
                <div class="suggested-actions" id="suggested-actions">
                    <button class="suggestion-btn" data-action="correct" aria-label="Correct something">‚úèÔ∏è Correct something</button>
                    <button class="suggestion-btn" data-action="generate" aria-label="Generate scene">üé¨ Generate scene</button>
                    <button class="suggestion-btn" data-action="details" aria-label="Add more details">‚ûï Add more details</button>
                </div>

                <!-- Voice Control - collapsible, hidden by default -->
                <div class="controls" id="voice-controls">
                    <!-- VAD Controls -->
                    <div class="vad-controls" id="vad-controls">
                        <div class="vad-toggle-row">
                            <label class="toggle-switch">
                                <input type="checkbox" id="vad-enabled" aria-label="Enable voice activity detection">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="vad-label">Auto-detect voice</span>
                            <div class="vad-indicator" id="vad-indicator" title="Voice activity indicator">
                                <span class="vad-dot"></span>
                            </div>
                        </div>
                        <div class="vad-settings hidden" id="vad-settings">
                            <div class="vad-setting">
                                <label for="vad-sensitivity">Sensitivity</label>
                                <input type="range" id="vad-sensitivity" min="0.005" max="0.05" step="0.001" value="0.015">
                                <span class="vad-value" id="vad-sensitivity-value">Medium</span>
                            </div>
                            <div class="vad-setting">
                                <label for="vad-silence">Silence timeout</label>
                                <input type="range" id="vad-silence" min="1" max="5" step="0.5" value="2">
                                <span class="vad-value" id="vad-silence-value">2.0s</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mic-container">
                        <div class="waveform-ring" id="waveform-ring"></div>
                        <canvas id="audio-visualizer" width="140" height="140"></canvas>
                        <button id="mic-btn" class="mic-btn" disabled aria-label="Start recording">
                            üé§ <span class="btn-text">Speak Now</span>
                        </button>
                    </div>
                    <div class="status-indicator" id="status-indicator">
                        <span id="status-text">Ready to listen</span>
                    </div>
                    
                    <!-- Audio Quality Indicator -->
                    <div id="audio-quality-container" class="audio-quality-container"></div>
                </div>

                <!-- Text Input ‚Äî always visible -->
                <div class="text-input">
                    <button id="chat-mic-btn" class="btn btn-mic" disabled aria-label="Record voice" title="Hold to record">üé§</button>
                    <button id="upload-evidence-btn" class="evidence-upload-btn" onclick="uploadEvidence()" aria-label="Attach photo evidence" title="Attach photo">
                        üìé
                    </button>
                    <button id="upload-sketch-btn" class="evidence-upload-btn" onclick="uploadSketch()" aria-label="Upload hand-drawn sketch" title="Upload Sketch">
                        ‚úèÔ∏è
                    </button>
                    <input type="file" id="evidence-file-input" accept="image/*" style="display:none" onchange="handleEvidenceUpload(event)" aria-hidden="true">
                    <input type="file" id="sketch-file-input" accept="image/*" style="display:none" onchange="handleSketchUpload(event)" aria-hidden="true">
                    <input type="text" id="text-input" placeholder="Describe what you witnessed..." disabled aria-label="Text input for testimony">
                    <button id="send-btn" class="btn btn-primary" disabled aria-label="Send message">Send</button>
                    <button id="review-testimony-btn" class="btn btn-secondary review-testimony-btn" onclick="showTestimonySummary()" aria-label="Review testimony summary" title="Review Testimony" style="display:none;">
                        üìã
                    </button>
                </div>

                <div class="keyboard-hint">
                    Press <kbd>Space</kbd> to record ¬∑ <kbd>Esc</kbd> to cancel ¬∑ Enable <em>Auto-detect voice</em> for hands-free
                </div>
            </section>

            <!-- RIGHT COLUMN: Secondary - Scene & Timeline -->
            <aside class="scene-panel" role="complementary">
                <!-- Scene Stats -->
                <div class="scene-stats" id="progress-tracker">
                    <div class="stat-card"><div class="stat-value" id="version-count">0</div><div class="stat-label">Versions</div></div>
                    <div class="stat-card"><div class="stat-value" id="statement-count">0</div><div class="stat-label">Statements</div></div>
                    <div class="stat-card"><div class="stat-value" id="session-duration">0m</div><div class="stat-label">Duration</div></div>
                    <div class="stat-card" id="complexity-card" style="display:none;"><div class="stat-value" id="complexity-score">--</div><div class="stat-label">Complexity</div></div>
                    <div class="stat-card warning" id="contradiction-card" style="display:none;"><div class="stat-value" id="contradiction-count">0</div><div class="stat-label">Contradictions</div></div>
                </div>

                <!-- Investigation Progress -->
                <div class="investigation-progress" id="investigation-progress">
                    <div class="progress-header">
                        <span class="progress-title">Report Completeness</span>
                        <span class="progress-pct" id="progress-pct">0%</span>
                    </div>
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill" id="progress-bar-fill" style="width:0%"></div>
                    </div>
                    <ul class="progress-checklist" id="progress-checklist">
                        <li data-cat="location"><span class="check-icon">‚¨ú</span> üìç Location identified</li>
                        <li data-cat="people"><span class="check-icon">‚¨ú</span> üë• People described</li>
                        <li data-cat="vehicles"><span class="check-icon">‚¨ú</span> üöó Vehicles noted</li>
                        <li data-cat="timeline"><span class="check-icon">‚¨ú</span> ‚è±Ô∏è Timeline established</li>
                        <li data-cat="evidence"><span class="check-icon">‚¨ú</span> üîç Evidence collected</li>
                    </ul>
                </div>

                <!-- Scene Display -->
                <h3 class="section-title">Scene Reconstruction</h3>
                <div id="scene-display" class="scene-display" role="img" aria-label="Reconstructed scene">
                    <div class="placeholder">
                        <div class="placeholder-icon">üì∑</div>
                        <p>Scene will be generated as you describe the incident</p>
                        <p class="placeholder-hint">Start by telling us what happened ‚Äî speak or type below</p>
                    </div>
                    <div class="scene-controls hidden">
                        <button class="scene-control-btn" id="zoom-btn" data-tooltip="Zoom" aria-label="Zoom scene">üîç</button>
                        <button class="scene-control-btn" id="measure-btn" data-tooltip="Measure" aria-label="Measurement tools">üìè</button>
                        <button class="scene-control-btn" id="download-btn" data-tooltip="Download" aria-label="Download scene">‚¨áÔ∏è</button>
                        <button class="scene-control-btn" id="fullscreen-btn" data-tooltip="Fullscreen" aria-label="Fullscreen">‚õ∂</button>
                        <button class="scene-control-btn" id="compare-btn" data-tooltip="Compare versions" aria-label="Compare versions">üîÄ</button>
                    </div>
                </div>
                <div id="scene-description" class="scene-description"><p>No scene generated yet</p></div>

                <!-- Witness Sketches Gallery -->
                <div class="witness-sketches-panel" id="witness-sketches-panel" style="display:none;">
                    <div class="sketches-header">
                        <h4>‚úèÔ∏è Witness Sketches</h4>
                        <span class="sketches-count" id="sketches-count">0</span>
                    </div>
                    <div class="sketches-gallery" id="sketches-gallery">
                        <p class="empty-state">No sketches uploaded yet. Use the ‚úèÔ∏è button to upload hand-drawn sketches.</p>
                    </div>
                </div>

                <!-- Environmental Conditions Panel -->
                <div class="environmental-conditions-panel" id="environmental-conditions-panel">
                    <div class="conditions-header">
                        <h4>üå§Ô∏è Environmental Conditions</h4>
                        <button class="conditions-toggle-btn" onclick="toggleConditionsPanel()" title="Toggle conditions">‚ñº</button>
                    </div>
                    <div class="conditions-content" id="conditions-content">
                        <div class="condition-row">
                            <label for="weather-select">
                                <span class="condition-icon">‚òÅÔ∏è</span> Weather
                            </label>
                            <select id="weather-select" class="condition-select" onchange="updateEnvironmentalConditions()">
                                <option value="clear" data-icon="‚òÄÔ∏è">Clear</option>
                                <option value="rain" data-icon="üåßÔ∏è">Rain</option>
                                <option value="snow" data-icon="‚ùÑÔ∏è">Snow</option>
                                <option value="fog" data-icon="üå´Ô∏è">Fog</option>
                            </select>
                        </div>
                        <div class="condition-row">
                            <label for="lighting-select">
                                <span class="condition-icon">üí°</span> Lighting
                            </label>
                            <select id="lighting-select" class="condition-select" onchange="updateEnvironmentalConditions()">
                                <option value="daylight" data-icon="üåû">Daylight</option>
                                <option value="dusk" data-icon="üåÖ">Dusk</option>
                                <option value="night" data-icon="üåô">Night</option>
                                <option value="artificial" data-icon="üí°">Artificial</option>
                            </select>
                        </div>
                        <div class="condition-row">
                            <label for="visibility-select">
                                <span class="condition-icon">üëÅÔ∏è</span> Visibility
                            </label>
                            <select id="visibility-select" class="condition-select" onchange="updateEnvironmentalConditions()">
                                <option value="good" data-icon="‚úÖ">Good</option>
                                <option value="moderate" data-icon="‚ö†Ô∏è">Moderate</option>
                                <option value="poor" data-icon="‚ùå">Poor</option>
                            </select>
                        </div>
                        <div class="conditions-preview" id="conditions-preview">
                            <span class="preview-label">Preview:</span>
                            <span class="preview-icons" id="preview-icons">‚òÄÔ∏è üåû ‚úÖ</span>
                        </div>
                    </div>
                </div>

                <!-- Scene Element Library & Editor -->
                <div class="scene-editor-container" id="scene-editor-container">
                    <div class="element-palette-header">
                        <h4>üé® Scene Elements</h4>
                        <div class="palette-header-controls">
                            <div class="view-toggle-group">
                                <button class="view-toggle-btn active" id="view-2d-btn" onclick="toggleSceneView('2d')" title="2D View">2D</button>
                                <button class="view-toggle-btn" id="view-3d-btn" onclick="toggleSceneView('3d')" title="3D View">3D</button>
                            </div>
                            <button class="template-selector-btn" onclick="sceneTemplateManager.showTemplateSelector()" title="Choose Template">üìê Templates</button>
                            <button class="palette-toggle-btn" onclick="sceneElementLibrary.togglePalette()" title="Toggle palette">‚ñº</button>
                        </div>
                    </div>
                    <div id="scene-element-palette" class="scene-element-palette">
                        <!-- Populated by scene-elements.js -->
                    </div>
                    <div id="scene-editor-canvas" class="show-grid" style="height: 350px;">
                        <div class="placeholder" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
                            <span style="font-size: 2rem;">üéØ</span>
                            <p style="margin-top: 8px; font-size: 0.85rem;">Drag elements here or click to place</p>
                        </div>
                    </div>
                    <div id="scene-3d-canvas" class="scene-3d-canvas" style="height: 350px; display: none;">
                        <!-- 3D viewer rendered here -->
                    </div>
                    <div id="scene-3d-controls" class="scene-3d-controls" style="display: none;">
                        <button class="scene-3d-btn" onclick="scene3DViewer.resetCamera()" title="Reset Camera">üè†</button>
                        <button class="scene-3d-btn" onclick="scene3DViewer.toggleGrid()" title="Toggle Grid">üî≤</button>
                        <button class="scene-3d-btn" onclick="scene3DViewer.syncFromLibrary()" title="Sync from 2D">üîÑ</button>
                    </div>
                    <!-- Scene Animation Controls -->
                    <div id="scene-animation-container" class="scene-animation-container" style="display: none;">
                        <!-- Populated by scene-animation.js -->
                    </div>
                </div>

                <!-- Evidence Board -->
                <div class="evidence-board" id="evidence-board">
                    <h3 class="evidence-title">Evidence Board</h3>
                    <div class="evidence-cards" id="evidence-cards">
                        <p class="empty-state">Evidence will appear as you describe the scene</p>
                    </div>
                    <div class="evidence-timeline" id="evidence-timeline" style="display:none;">
                        <h4>Event Timeline</h4>
                        <div class="timeline-events" id="timeline-events"></div>
                    </div>
                </div>

                <!-- Timeline -->
                <div class="timeline-panel" role="complementary" aria-label="Scene version timeline">
                    <h3>Version History</h3>
                    <div id="timeline" class="timeline">
                        <p class="empty-state">No versions yet</p>
                    </div>
                </div>

                <!-- Export Controls -->
                <div class="export-controls" id="export-controls" style="display:none;">
                    <h4>Export Report</h4>
                    <div class="export-buttons">
                        <button class="btn btn-secondary btn-export" id="export-pdf-btn">üìÑ PDF Report</button>
                        <button class="btn btn-secondary btn-export" id="export-json-btn">üì¶ JSON Data</button>
                        <button class="btn btn-secondary btn-export" id="export-evidence-btn" data-tooltip="Law enforcement evidence report">üîí Evidence Report</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Template Selector Modal -->
    <div id="template-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="template-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="template-modal-title">üìã What type of incident are you reporting?</h2>
                <button class="modal-close" id="close-template-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <p class="modal-description">Select the type of incident to help guide the interview with relevant questions.</p>
            <div id="template-grid" class="template-grid">
                <p class="empty-state">Loading templates...</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="skip-template-btn">Skip - General Report</button>
            </div>
        </div>
    </div>

    <!-- Session List Modal -->
    <div id="session-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Your Sessions</h2>
                <button class="modal-close" id="close-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <div id="session-list" class="session-list">
                <p class="empty-state">Loading sessions...</p>
            </div>
            <button class="btn btn-secondary" id="modal-close-btn-2">Close</button>
        </div>
    </div>

    <!-- Model & Quota Modal -->
    <div id="quota-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="quota-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="quota-modal-title">ü§ñ Gemini Model & Quota</h2>
                <button class="modal-close" id="close-quota-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <!-- Model Selector -->
            <div class="model-selector-section">
                <h3>Active Model</h3>
                <div class="model-select-group">
                    <div class="model-select-wrapper">
                        <select id="model-select" class="model-select" aria-label="Select Gemini model">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                    <button id="apply-model-btn" class="btn btn-primary" disabled>Apply</button>
                </div>
                <p class="model-help-text">
                    üí° Free tier recommended: <strong>gemini-2.5-flash</strong> (15 RPM, 15M tokens/day)
                </p>
            </div>

            <!-- Quota Dashboard -->
            <div class="quota-dashboard">
                <h3>Usage & Quota</h3>
                
                <div class="quota-grid">
                    <!-- Requests Per Minute -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Requests / Minute</h4>
                            <span class="quota-badge" id="rpm-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="rpm-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="rpm-used">0</span> / <span id="rpm-limit">--</span> requests
                        </p>
                    </div>

                    <!-- Requests Per Day -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Requests / Day</h4>
                            <span class="quota-badge" id="rpd-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="rpd-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="rpd-used">0</span> / <span id="rpd-limit">--</span> requests
                        </p>
                    </div>

                    <!-- Tokens Per Day -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Tokens / Day</h4>
                            <span class="quota-badge" id="tpd-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="tpd-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="tpd-used">0</span> / <span id="tpd-limit">--</span> tokens
                        </p>
                    </div>
                </div>

                <div class="quota-footer">
                    <p class="quota-disclaimer">
                        ‚ö†Ô∏è <strong>Local tracking</strong>: Gemini API does not provide programmatic quota endpoints. 
                        Usage is tracked locally and resets at midnight UTC. Counts are approximate.
                    </p>
                    <button id="refresh-quota-btn" class="btn btn-secondary">üîÑ Refresh</button>
                </div>
            </div>

            <button class="btn btn-secondary" id="modal-close-quota-btn-2">Close</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="analytics-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="analytics-modal-title">üìä Session Analytics</h2>
                <button class="modal-close" id="close-analytics-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="analytics-dashboard">
                <h3>Overall Statistics</h3>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-icon">üìù</div>
                        <div class="analytics-value" id="analytics-total-sessions">--</div>
                        <div class="analytics-label">Total Sessions</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">üé¨</div>
                        <div class="analytics-value" id="analytics-active-sessions">--</div>
                        <div class="analytics-label">Active Sessions</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">üñºÔ∏è</div>
                        <div class="analytics-value" id="analytics-total-scenes">--</div>
                        <div class="analytics-label">Scenes Generated</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">‚è±Ô∏è</div>
                        <div class="analytics-value" id="analytics-avg-duration">--</div>
                        <div class="analytics-label">Avg Session Time</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 2rem;">Element Insights</h3>
                <div class="element-insights">
                    <div class="insight-row">
                        <span class="insight-label">Most Common Elements:</span>
                        <span class="insight-value" id="analytics-top-elements">--</span>
                    </div>
                    <div class="insight-row">
                        <span class="insight-label">Average Confidence:</span>
                        <span class="insight-value" id="analytics-avg-confidence">--</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-close-analytics-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Server Info Modal -->
    <div id="info-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="info-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="info-modal-title">‚ÑπÔ∏è Server Information</h2>
                <button class="modal-close" id="close-info-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="server-info-panel">
                <div class="info-section">
                    <h4>System Status</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-key">Version:</span>
                            <span class="info-value" id="info-version">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Environment:</span>
                            <span class="info-value" id="info-env">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Python:</span>
                            <span class="info-value" id="info-python">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Debug Mode:</span>
                            <span class="info-value" id="info-debug">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>Available Features</h4>
                    <div class="feature-badges" id="feature-badges">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>Configuration</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-key">Active Model:</span>
                            <span class="info-value" id="info-model">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Rate Limiting:</span>
                            <span class="info-value" id="info-rate-limit">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-close-info-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div id="onboarding-overlay" class="onboarding-overlay hidden" role="dialog" aria-modal="true">
        <div class="onboarding-content">
            <!-- Step 1 -->
            <div class="onboarding-step active" data-step="1">
                <div class="onboarding-icon">üö®</div>
                <h2>Welcome to WitnessReplay</h2>
                <p>We're here to help you <strong>report an incident</strong> ‚Äî whether it's an accident, crime, or any event you witnessed. You can speak or type, and we'll guide you through the process.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" id="skip-onboarding">Skip</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 2 -->
            <div class="onboarding-step" data-step="2">
                <div class="onboarding-icon">üé§</div>
                <h2>Speak or Type</h2>
                <p>Describe what you saw in your own words. Click the microphone or press <kbd>Space</kbd> to start recording, or simply type in the chat. We'll listen carefully and begin building a record of the incident.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">‚¨Ö Back</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 3 -->
            <div class="onboarding-step" data-step="3">
                <div class="onboarding-icon">üí¨</div>
                <h2>Guided Reporting</h2>
                <p>We'll ask clarifying questions to capture the full picture. Answer naturally. If something needs correcting, just say so ‚Äî "The car was blue, not red" ‚Äî and we'll update the record immediately.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">‚¨Ö Back</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 4 -->
            <div class="onboarding-step" data-step="4">
                <div class="onboarding-icon">‚úÖ</div>
                <h2>Ready to Report</h2>
                <p>Your report is saved automatically. You can review the timeline, scene reconstruction, export to PDF, or start a new report anytime. Let's document what you witnessed.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">‚¨Ö Back</button>
                    <button class="btn btn-success" id="start-session-btn">Start Report ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>

    <!-- Witness Information Form (Item 27) -->
    <div id="witness-info-overlay" class="witness-info-overlay" style="display:none;" role="dialog" aria-modal="true" aria-label="Witness information form">
        <div class="witness-form">
            <h3>Witness Information <span class="optional-badge">Optional</span></h3>
            <p class="form-note">This information helps officers follow up. You may remain anonymous.</p>
            <div class="form-grid">
                <div class="form-group">
                    <label for="witness-name">Name</label>
                    <input type="text" id="witness-name" placeholder="Your name (optional)" aria-label="Witness name">
                </div>
                <div class="form-group">
                    <label for="witness-contact">Contact</label>
                    <input type="text" id="witness-contact" placeholder="Phone or email (optional)" aria-label="Contact information">
                </div>
                <div class="form-group form-group-full">
                    <label for="witness-location">Location at time of incident</label>
                    <div class="location-input-wrapper">
                        <input type="text" id="witness-location" placeholder="Enter address or use GPS" aria-label="Location at time of incident" autocomplete="off">
                        <button type="button" id="gps-location-btn" class="gps-btn" title="Get current GPS location" aria-label="Get current location">
                            üìç
                        </button>
                        <div id="location-suggestions" class="location-suggestions" role="listbox"></div>
                    </div>
                    <div id="location-coordinates" class="location-coordinates"></div>
                    <div id="location-map" class="location-map-container"></div>
                </div>
            </div>
            <div class="witness-form-actions">
                <button onclick="startInterview()" class="btn btn-primary">Begin Interview</button>
                <button onclick="skipInfo()" class="btn-text-link">Skip &amp; Start Anonymous Interview</button>
            </div>
        </div>
    </div>

    <!-- Testimony Summary Modal (Item 26) -->
    <div id="testimony-summary-modal" class="modal" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="testimony-summary-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="testimony-summary-title">üìã Testimony Summary</h2>
                <button class="modal-close" onclick="closeSummary()" aria-label="Close summary">&times;</button>
            </div>
            <div id="summary-content">
                <div class="summary-section">
                    <h3>Your Statements</h3>
                    <div id="summary-statements"></div>
                </div>
                <div class="summary-section">
                    <h3>Key Details Mentioned</h3>
                    <div id="summary-elements"></div>
                </div>
            </div>
            <div class="summary-actions">
                <button onclick="closeSummary()" class="btn btn-secondary">Continue Interview</button>
                <button onclick="submitTestimony()" class="btn btn-primary">Submit Testimony</button>
            </div>
        </div>
    </div>

    <!-- Help Button -->
    <button class="help-button" id="help-btn" data-tooltip="Help & Tutorial" aria-label="Help">
        ?
    </button>

    <!-- Scripts -->
    <script src="/static/js/audio.js"></script>
    <script src="/static/js/audio-quality.js"></script>
    <script src="/static/js/vad.js"></script>
    <script src="/static/js/ui.js"></script>
    <script src="/static/js/measurements.js"></script>
    <script src="/static/js/evidence-markers.js"></script>
    <script src="/static/js/scene-elements.js"></script>
    <script src="/static/js/scene-templates.js"></script>
    <script src="/static/js/scene-3d.js"></script>
    <script src="/static/js/scene-animation.js"></script>
    <script src="/static/js/location.js"></script>
    <script src="/static/js/app.js"></script>
    
    <!-- Initialize Scene Element Library and 3D Viewer -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (window.sceneElementLibrary) {
                window.sceneElementLibrary.init();
            }
            if (window.scene3DViewer) {
                window.scene3DViewer.init();
            }
        });
        
        // Toggle between 2D and 3D scene views
        let currentSceneView = '2d';
        function toggleSceneView(view) {
            if (view === currentSceneView) return;
            currentSceneView = view;
            
            const canvas2d = document.getElementById('scene-editor-canvas');
            const canvas3d = document.getElementById('scene-3d-canvas');
            const controls3d = document.getElementById('scene-3d-controls');
            const btn2d = document.getElementById('view-2d-btn');
            const btn3d = document.getElementById('view-3d-btn');
            const palette = document.getElementById('scene-element-palette');
            
            if (view === '3d') {
                // Switch to 3D
                canvas2d.style.display = 'none';
                canvas3d.style.display = 'block';
                controls3d.style.display = 'flex';
                palette.style.display = 'none';
                btn2d.classList.remove('active');
                btn3d.classList.add('active');
                
                if (window.scene3DViewer) {
                    window.scene3DViewer.activate(canvas3d);
                }
            } else {
                // Switch to 2D
                canvas2d.style.display = 'block';
                canvas3d.style.display = 'none';
                controls3d.style.display = 'none';
                palette.style.display = '';
                btn2d.classList.add('active');
                btn3d.classList.remove('active');
                
                if (window.scene3DViewer) {
                    window.scene3DViewer.deactivate();
                }
            }
        }
    </script>
    
    <!-- Inline helper functions for onboarding -->
    <script>
        let currentOnboardingStep = 1;
        
        function nextOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            if (currentOnboardingStep < steps.length) {
                steps[currentOnboardingStep - 1].classList.remove('active');
                currentOnboardingStep++;
                steps[currentOnboardingStep - 1].classList.add('active');
            }
        }
        
        function prevOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            if (currentOnboardingStep > 1) {
                steps[currentOnboardingStep - 1].classList.remove('active');
                currentOnboardingStep--;
                steps[currentOnboardingStep - 1].classList.add('active');
            }
        }
        
        function closeOnboarding() {
            document.getElementById('onboarding-overlay').classList.add('hidden');
            localStorage.setItem('witnessreplay-onboarding-completed', 'true');
        }
        
        document.getElementById('skip-onboarding')?.addEventListener('click', closeOnboarding);
        document.getElementById('start-session-btn')?.addEventListener('click', closeOnboarding);
        
        // Initialize app
        window.app = new WitnessReplayApp();
    </script>

    <!-- Comparison Modal -->
    <div id="comparison-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="comparison-modal-title">
        <div class="modal-content modal-fullwidth">
            <div class="modal-header">
                <h2 id="comparison-modal-title">üîÄ Version Comparison</h2>
                <button class="modal-close" id="close-comparison-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <!-- Version selectors -->
            <div class="comparison-selectors">
                <div class="comparison-selector-group">
                    <label for="comparison-version-a">Compare:</label>
                    <select id="comparison-version-a" class="comparison-select">
                        <option value="">Select version...</option>
                    </select>
                </div>
                <span class="comparison-vs">vs</span>
                <div class="comparison-selector-group">
                    <label for="comparison-version-b">With:</label>
                    <select id="comparison-version-b" class="comparison-select">
                        <option value="">Select version...</option>
                    </select>
                </div>
                <button id="compare-versions-btn" class="btn btn-primary btn-sm">Compare</button>
            </div>
            <!-- Diff Summary -->
            <div id="comparison-diff-summary" class="comparison-diff-summary hidden">
                <div class="diff-badge diff-added"><span class="diff-count" id="diff-added-count">0</span> Added</div>
                <div class="diff-badge diff-removed"><span class="diff-count" id="diff-removed-count">0</span> Removed</div>
                <div class="diff-badge diff-changed"><span class="diff-count" id="diff-changed-count">0</span> Changed</div>
                <div class="diff-badge diff-unchanged"><span class="diff-count" id="diff-unchanged-count">0</span> Unchanged</div>
            </div>
            <div class="comparison-modal-body">
                <div class="comparison-panel">
                    <div class="comparison-header">
                        <span id="comparison-header-a">Version A</span>
                        <span class="comparison-timestamp" id="comparison-timestamp-a"></span>
                    </div>
                    <div id="comparison-before" class="comparison-image-container">
                        <!-- Before image inserted here -->
                    </div>
                    <div id="comparison-before-description" class="comparison-description">
                        <!-- Description -->
                    </div>
                    <div id="comparison-elements-a" class="comparison-elements">
                        <!-- Elements list -->
                    </div>
                </div>
                <div class="comparison-divider-vertical">
                    <div class="divider-handle">‚áÑ</div>
                </div>
                <div class="comparison-panel">
                    <div class="comparison-header">
                        <span id="comparison-header-b">Version B</span>
                        <span class="comparison-timestamp" id="comparison-timestamp-b"></span>
                    </div>
                    <div id="comparison-after" class="comparison-image-container">
                        <!-- After image inserted here -->
                    </div>
                    <div id="comparison-after-description" class="comparison-description">
                        <!-- Description -->
                    </div>
                    <div id="comparison-elements-b" class="comparison-elements">
                        <!-- Elements list -->
                    </div>
                </div>
            </div>
            <!-- Detailed changes panel -->
            <div id="comparison-changes-panel" class="comparison-changes-panel hidden">
                <h4>üîç Detailed Changes</h4>
                <div id="comparison-changes-list" class="comparison-changes-list">
                    <!-- Changes rendered here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="toggle-comparison-mode-btn" data-tooltip="Toggle comparison mode in scene viewer">üìê Toggle Compare Mode</button>
                <button class="btn btn-secondary" id="modal-close-comparison-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Overlay -->
    <div id="shortcuts-overlay" class="shortcuts-overlay hidden" role="dialog" aria-modal="true">
        <div class="shortcuts-content">
            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <kbd>Space</kbd>
                    <span>Start/Stop recording</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Esc</kbd>
                    <span>Cancel recording / Close modal</span>
                </div>
                <div class="shortcut-item">
                    <kbd>?</kbd>
                    <span>Show this help</span>
                </div>
                <div class="shortcut-item">
                    <kbd>N</kbd>
                    <span>New session</span>
                </div>
                <div class="shortcut-item">
                    <kbd>S</kbd>
                    <span>Show sessions list</span>
                </div>
                <div class="shortcut-item">
                    <kbd>M</kbd>
                    <span>Open model selector</span>
                </div>
                <div class="shortcut-item">
                    <kbd>A</kbd>
                    <span>Show analytics</span>
                </div>
                <div class="shortcut-item">
                    <kbd>I</kbd>
                    <span>Server information</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="window.app.hideShortcuts()">Close</button>
        </div>
    </div>

    <!-- Onboarding Modal (First-Time Experience) -->
    <div id="onboarding-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="onboarding-title">
        <div class="modal-content modal-wide onboarding-modal">
            <div class="modal-header onboarding-header">
                <h2 id="onboarding-title">üëã Welcome to WitnessReplay</h2>
            </div>
            
            <div class="onboarding-content onboarding-grid">
                <div class="onboarding-step">
                    <div class="onboarding-icon">üé§</div>
                    <h3>Speak or Type Your Account</h3>
                    <p>Describe what you witnessed naturally ‚Äî use your voice or type. Our AI listens carefully to every detail.</p>
                </div>
                
                <div class="onboarding-step">
                    <div class="onboarding-icon">üõ°Ô∏è</div>
                    <h3>Detective Ray Guides You</h3>
                    <p>Our AI detective will ask follow-up questions to build a complete picture of the incident.</p>
                </div>
                
                <div class="onboarding-step">
                    <div class="onboarding-icon">üé¨</div>
                    <h3>Visual Scene Reconstruction</h3>
                    <p>Watch as your account is reconstructed as a visual scene. Make corrections and add details anytime.</p>
                </div>
                
                <div class="onboarding-step">
                    <div class="onboarding-icon">üìã</div>
                    <h3>Export Your Report</h3>
                    <p>Export complete incident reports with evidence boards, timelines, and scene reconstructions.</p>
                </div>            </div>
            
            <div class="onboarding-footer">
                <label class="onboarding-checkbox">
                    <input type="checkbox" id="dont-show-onboarding">
                    <span>Don't show this again</span>
                </label>
                <button class="btn btn-primary btn-lg" id="onboarding-start-btn">Get Started ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Version Display -->
    <div class="version-badge" id="version-display">
        <span class="version-label">WitnessReplay</span>
        <span class="version-number">v2.0</span>
        <span class="version-separator">‚Ä¢</span>
        <span class="version-challenge">Gemini Live Agent Challenge</span>
    </div>
    
    <!-- Particle Background Canvas -->
    <canvas id="particle-canvas" class="particle-canvas"></canvas>
</body>
</html>
