<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="WitnessReplay - AI-powered voice-driven crime scene reconstruction. Describe what you saw, and Detective Ray will rebuild the scene.">
    <meta name="theme-color" content="#00d4ff">
    <title>WitnessReplay - Detective Ray's Scene Reconstruction</title>
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/static/css/styles.css">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
</head>
<body>
    <!-- Main Container -->
    <div class="container">
        <!-- Header with Detective Ray -->
        <header class="header">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-icon">üéôÔ∏è</div>
                    <div class="logo-text">
                        <h1>WitnessReplay</h1>
                        <p class="tagline">Describe what you saw. I'll rebuild the scene.</p>
                    </div>
                </div>
                
                <div class="detective-badge">
                    <div class="detective-avatar">üîç</div>
                    <div class="detective-info">
                        <h3>Detective Ray</h3>
                        <p>Case Analyst &bull; Online</p>
                    </div>
                </div>
                
                <div class="session-info">
                    <div class="session-status">
                        <span class="status-dot"></span>
                        <span id="session-id">Initializing...</span>
                    </div>
                    <button id="new-session-btn" class="btn btn-secondary">
                        ‚ûï New Session
                    </button>
                    <button id="sessions-list-btn" class="btn btn-secondary" data-tooltip="View all sessions">
                        üìã Sessions
                    </button>
                    <button id="quota-btn" class="btn btn-secondary" data-tooltip="Model & Quota">
                        ü§ñ Model
                    </button>
                    <button id="analytics-btn" class="btn btn-secondary" data-tooltip="View analytics">
                        üìä Analytics
                    </button>
                    <button id="info-btn" class="btn btn-secondary" data-tooltip="Server info">
                        ‚ÑπÔ∏è Info
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content: 3-Column Layout -->
        <div class="main-content">
            <!-- LEFT: Timeline Panel -->
            <aside class="timeline-panel" role="complementary" aria-label="Scene version timeline">
                <h3>Timeline</h3>
                <div id="timeline" class="timeline">
                    <p class="empty-state">No versions yet</p>
                </div>
            </aside>

            <!-- CENTER: Scene Display Panel -->
            <main class="scene-panel" role="main">
                <h2>Scene Reconstruction</h2>
                
                <!-- Scene Stats / Progress Tracker -->
                <div class="scene-stats" id="progress-tracker">
                    <div class="stat-card">
                        <div class="stat-value" id="version-count">0</div>
                        <div class="stat-label">Versions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statement-count">0</div>
                        <div class="stat-label">Statements</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="session-duration">0m</div>
                        <div class="stat-label">Duration</div>
                    </div>
                    <div class="stat-card" id="complexity-card" style="display: none;">
                        <div class="stat-value" id="complexity-score">--</div>
                        <div class="stat-label">Complexity</div>
                    </div>
                    <div class="stat-card warning" id="contradiction-card" style="display: none;">
                        <div class="stat-value" id="contradiction-count">0</div>
                        <div class="stat-label">‚ö†Ô∏è Contradictions</div>
                    </div>
                </div>

                <!-- Investigation Progress Bar -->
                <div class="investigation-progress" id="investigation-progress">
                    <div class="progress-header">
                        <span class="progress-title">Investigation Progress</span>
                        <span class="progress-pct" id="progress-pct">0%</span>
                    </div>
                    <div class="progress-bar-track">
                        <div class="progress-bar-fill" id="progress-bar-fill" style="width:0%"></div>
                    </div>
                    <ul class="progress-checklist" id="progress-checklist">
                        <li data-cat="location"><span class="check-icon">‚¨ú</span> Location identified</li>
                        <li data-cat="people"><span class="check-icon">‚¨ú</span> People described</li>
                        <li data-cat="vehicles"><span class="check-icon">‚¨ú</span> Vehicles noted</li>
                        <li data-cat="timeline"><span class="check-icon">‚¨ú</span> Timeline established</li>
                        <li data-cat="evidence"><span class="check-icon">‚¨ú</span> Evidence collected</li>
                    </ul>
                </div>
                
                <!-- Scene Display Canvas -->
                <div id="scene-display" class="scene-display" role="img" aria-label="Reconstructed scene">
                    <div class="placeholder">
                        <div class="placeholder-icon">üé¨</div>
                        <p>Start speaking to begin reconstruction</p>
                    </div>
                    
                    <!-- Scene Controls (appear on hover) -->
                    <div class="scene-controls hidden">
                        <button class="scene-control-btn" id="zoom-btn" data-tooltip="Zoom" aria-label="Zoom scene">
                            üîç
                        </button>
                        <button class="scene-control-btn" id="download-btn" data-tooltip="Download" aria-label="Download scene">
                            ‚¨áÔ∏è
                        </button>
                        <button class="scene-control-btn" id="fullscreen-btn" data-tooltip="Fullscreen" aria-label="Fullscreen">
                            ‚õ∂
                        </button>
                    </div>
                </div>
                
                <!-- Scene Description -->
                <div id="scene-description" class="scene-description">
                    <p>No scene generated yet</p>
                </div>

                <!-- Evidence Board -->
                <div class="evidence-board" id="evidence-board">
                    <h3 class="evidence-title">üìã Evidence Board</h3>
                    <div class="evidence-cards" id="evidence-cards">
                        <p class="empty-state">Evidence will appear as you describe the scene</p>
                    </div>
                    <div class="evidence-timeline" id="evidence-timeline" style="display:none;">
                        <h4>üìÖ Event Timeline</h4>
                        <div class="timeline-events" id="timeline-events"></div>
                    </div>
                </div>
                
                <!-- Export Controls -->
                <div class="export-controls" id="export-controls" style="display: none;">
                    <h4>Export Session</h4>
                    <div class="export-buttons">
                        <button class="btn btn-secondary btn-export" id="export-pdf-btn">
                            üìÑ PDF Report
                        </button>
                        <button class="btn btn-secondary btn-export" id="export-json-btn">
                            üì¶ JSON Data
                        </button>
                        <button class="btn btn-secondary btn-export" id="export-evidence-btn" data-tooltip="Law enforcement compatible evidence report">
                            üîí Evidence Report
                        </button>
                    </div>
                </div>

                <!-- Voice Control Center -->
                <div class="controls">
                    <div class="mic-container">
                        <!-- Waveform Ring -->
                        <div class="waveform-ring" id="waveform-ring"></div>
                        
                        <!-- Audio Visualizer (canvas) -->
                        <canvas id="audio-visualizer" width="140" height="140"></canvas>
                        
                        <!-- Microphone Button -->
                        <button id="mic-btn" class="mic-btn" disabled aria-label="Start recording">
                            üé§ <span class="btn-text">Start Speaking</span>
                        </button>
                    </div>
                    
                    <!-- Status Indicator -->
                    <div class="status-indicator" id="status-indicator">
                        <span id="status-text">Initializing...</span>
                    </div>
                    
                    <!-- Keyboard Hint -->
                    <div class="keyboard-hint">
                        Press <kbd>Space</kbd> to record &bull; <kbd>Esc</kbd> to cancel &bull; <kbd>?</kbd> for help
                    </div>
                </div>
            </main>

            <!-- RIGHT: Chat/Conversation Panel -->
            <aside class="chat-panel" role="complementary" aria-label="Conversation transcript">
                <h3>Conversation</h3>
                <div id="chat-transcript" class="chat-transcript" role="log" aria-live="polite">
                    <p class="empty-state">Conversation will appear here</p>
                </div>

                <!-- Typing indicator -->
                <div class="typing-indicator hidden" id="typing-indicator">
                    <span class="typing-avatar">üîç</span>
                    <div class="typing-dots">
                        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                    </div>
                </div>

                <!-- Suggested Actions -->
                <div class="suggested-actions" id="suggested-actions">
                    <button class="suggestion-btn" data-action="correct">‚úèÔ∏è Correct something</button>
                    <button class="suggestion-btn" data-action="generate">üé¨ Generate scene</button>
                    <button class="suggestion-btn" data-action="details">‚ûï Add more details</button>
                </div>
                
                <!-- Text Input (fallback) -->
                <div class="text-input">
                    <button id="chat-mic-btn" class="btn btn-mic" disabled aria-label="Record voice" title="Hold to record">
                        üé§
                    </button>
                    <input 
                        type="text" 
                        id="text-input" 
                        placeholder="Type your statement (or use voice)..."
                        disabled
                        aria-label="Text input"
                    >
                    <button id="send-btn" class="btn btn-primary" disabled aria-label="Send message">
                        ‚û§
                    </button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Session List Modal -->
    <div id="session-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Your Sessions</h2>
                <button class="modal-close" id="close-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <div id="session-list" class="session-list">
                <p class="empty-state">Loading sessions...</p>
            </div>
            <button class="btn btn-secondary" id="modal-close-btn-2">Close</button>
        </div>
    </div>

    <!-- Model & Quota Modal -->
    <div id="quota-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="quota-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="quota-modal-title">ü§ñ Gemini Model & Quota</h2>
                <button class="modal-close" id="close-quota-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <!-- Model Selector -->
            <div class="model-selector-section">
                <h3>Active Model</h3>
                <div class="model-select-group">
                    <div class="model-select-wrapper">
                        <select id="model-select" class="model-select" aria-label="Select Gemini model">
                            <option value="">Loading models...</option>
                        </select>
                    </div>
                    <button id="apply-model-btn" class="btn btn-primary" disabled>Apply</button>
                </div>
                <p class="model-help-text">
                    üí° Free tier recommended: <strong>gemini-2.5-flash</strong> (15 RPM, 15M tokens/day)
                </p>
            </div>

            <!-- Quota Dashboard -->
            <div class="quota-dashboard">
                <h3>Usage & Quota</h3>
                
                <div class="quota-grid">
                    <!-- Requests Per Minute -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Requests / Minute</h4>
                            <span class="quota-badge" id="rpm-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="rpm-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="rpm-used">0</span> / <span id="rpm-limit">--</span> requests
                        </p>
                    </div>

                    <!-- Requests Per Day -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Requests / Day</h4>
                            <span class="quota-badge" id="rpd-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="rpd-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="rpd-used">0</span> / <span id="rpd-limit">--</span> requests
                        </p>
                    </div>

                    <!-- Tokens Per Day -->
                    <div class="quota-card">
                        <div class="quota-header">
                            <h4>Tokens / Day</h4>
                            <span class="quota-badge" id="tpd-badge">--</span>
                        </div>
                        <div class="quota-bar-container">
                            <div class="quota-bar" id="tpd-bar" style="width: 0%"></div>
                        </div>
                        <p class="quota-label">
                            <span id="tpd-used">0</span> / <span id="tpd-limit">--</span> tokens
                        </p>
                    </div>
                </div>

                <div class="quota-footer">
                    <p class="quota-disclaimer">
                        ‚ö†Ô∏è <strong>Local tracking</strong>: Gemini API does not provide programmatic quota endpoints. 
                        Usage is tracked locally and resets at midnight UTC. Counts are approximate.
                    </p>
                    <button id="refresh-quota-btn" class="btn btn-secondary">üîÑ Refresh</button>
                </div>
            </div>

            <button class="btn btn-secondary" id="modal-close-quota-btn-2">Close</button>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="analytics-modal-title">
        <div class="modal-content modal-wide">
            <div class="modal-header">
                <h2 id="analytics-modal-title">üìä Session Analytics</h2>
                <button class="modal-close" id="close-analytics-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="analytics-dashboard">
                <h3>Overall Statistics</h3>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-icon">üìù</div>
                        <div class="analytics-value" id="analytics-total-sessions">--</div>
                        <div class="analytics-label">Total Sessions</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">üé¨</div>
                        <div class="analytics-value" id="analytics-active-sessions">--</div>
                        <div class="analytics-label">Active Sessions</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">üñºÔ∏è</div>
                        <div class="analytics-value" id="analytics-total-scenes">--</div>
                        <div class="analytics-label">Scenes Generated</div>
                    </div>
                    
                    <div class="analytics-card">
                        <div class="analytics-icon">‚è±Ô∏è</div>
                        <div class="analytics-value" id="analytics-avg-duration">--</div>
                        <div class="analytics-label">Avg Session Time</div>
                    </div>
                </div>
                
                <h3 style="margin-top: 2rem;">Element Insights</h3>
                <div class="element-insights">
                    <div class="insight-row">
                        <span class="insight-label">Most Common Elements:</span>
                        <span class="insight-value" id="analytics-top-elements">--</span>
                    </div>
                    <div class="insight-row">
                        <span class="insight-label">Average Confidence:</span>
                        <span class="insight-value" id="analytics-avg-confidence">--</span>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-close-analytics-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Server Info Modal -->
    <div id="info-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="info-modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="info-modal-title">‚ÑπÔ∏è Server Information</h2>
                <button class="modal-close" id="close-info-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            
            <div class="server-info-panel">
                <div class="info-section">
                    <h4>System Status</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-key">Version:</span>
                            <span class="info-value" id="info-version">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Environment:</span>
                            <span class="info-value" id="info-env">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Python:</span>
                            <span class="info-value" id="info-python">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Debug Mode:</span>
                            <span class="info-value" id="info-debug">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>Available Features</h4>
                    <div class="feature-badges" id="feature-badges">
                        <!-- Dynamically populated -->
                    </div>
                </div>
                
                <div class="info-section">
                    <h4>Configuration</h4>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-key">Active Model:</span>
                            <span class="info-value" id="info-model">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-key">Rate Limiting:</span>
                            <span class="info-value" id="info-rate-limit">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-close-info-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Overlay -->
    <div id="onboarding-overlay" class="onboarding-overlay hidden" role="dialog" aria-modal="true">
        <div class="onboarding-content">
            <!-- Step 1 -->
            <div class="onboarding-step active" data-step="1">
                <div class="onboarding-icon">üîç</div>
                <h2>Welcome to WitnessReplay</h2>
                <p>I'm <strong>Detective Ray</strong>, your AI partner in scene reconstruction. Together, we'll rebuild what you witnessed using the power of your voice and AI-generated imagery.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" id="skip-onboarding">Skip</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 2 -->
            <div class="onboarding-step" data-step="2">
                <div class="onboarding-icon">üé§</div>
                <h2>Speak Naturally</h2>
                <p>Just describe what you saw in your own words. Click the microphone or press <kbd>Space</kbd> to start recording. I'll listen carefully and start building the scene.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">‚¨Ö Back</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 3 -->
            <div class="onboarding-step" data-step="3">
                <div class="onboarding-icon">üí¨</div>
                <h2>Interactive Refinement</h2>
                <p>I'll ask clarifying questions to understand better. Answer naturally. If something looks wrong, just tell me ‚Äî "The car was blue, not red" ‚Äî and I'll update the scene immediately.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">‚¨Ö Back</button>
                    <button class="btn btn-primary" onclick="nextOnboardingStep()">Next ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                    <span class="indicator-dot"></span>
                </div>
            </div>
            
            <!-- Step 4 -->
            <div class="onboarding-step" data-step="4">
                <div class="onboarding-icon">‚úÖ</div>
                <h2>Ready to Begin</h2>
                <p>Your session is saved automatically. Use the timeline to view previous versions, export to PDF, or start a new session anytime. Let's reconstruct what you witnessed.</p>
                <div class="onboarding-actions">
                    <button class="btn btn-secondary" onclick="prevOnboardingStep()">‚¨Ö Back</button>
                    <button class="btn btn-success" id="start-session-btn">Start Session ‚û§</button>
                </div>
                <div class="onboarding-indicators">
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot"></span>
                    <span class="indicator-dot active"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="status" aria-live="polite"></div>

    <!-- Help Button -->
    <button class="help-button" id="help-btn" data-tooltip="Help & Tutorial" aria-label="Help">
        ?
    </button>

    <!-- Scripts -->
    <script src="/static/js/audio.js"></script>
    <script src="/static/js/ui.js"></script>
    <script src="/static/js/app.js"></script>
    
    <!-- Inline helper functions for onboarding -->
    <script>
        let currentOnboardingStep = 1;
        
        function nextOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            if (currentOnboardingStep < steps.length) {
                steps[currentOnboardingStep - 1].classList.remove('active');
                currentOnboardingStep++;
                steps[currentOnboardingStep - 1].classList.add('active');
            }
        }
        
        function prevOnboardingStep() {
            const steps = document.querySelectorAll('.onboarding-step');
            if (currentOnboardingStep > 1) {
                steps[currentOnboardingStep - 1].classList.remove('active');
                currentOnboardingStep--;
                steps[currentOnboardingStep - 1].classList.add('active');
            }
        }
        
        function closeOnboarding() {
            document.getElementById('onboarding-overlay').classList.add('hidden');
            localStorage.setItem('witnessreplay-onboarding-completed', 'true');
        }
        
        document.getElementById('skip-onboarding')?.addEventListener('click', closeOnboarding);
        document.getElementById('start-session-btn')?.addEventListener('click', closeOnboarding);
        
        // Initialize app
        window.app = new WitnessReplayApp();
    </script>

    <!-- Comparison Modal -->
    <div id="comparison-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="comparison-modal-title">
        <div class="modal-content modal-fullwidth">
            <div class="modal-header">
                <h2 id="comparison-modal-title">üîÄ Version Comparison</h2>
                <button class="modal-close" id="close-comparison-modal-btn" aria-label="Close modal">&times;</button>
            </div>
            <div class="comparison-modal-body">
                <div class="comparison-panel">
                    <div class="comparison-header">Before</div>
                    <div id="comparison-before" class="comparison-image-container">
                        <!-- Before image inserted here -->
                    </div>
                    <div id="comparison-before-description" class="comparison-description">
                        <!-- Description -->
                    </div>
                </div>
                <div class="comparison-divider-vertical">
                    <div class="divider-handle">‚áÑ</div>
                </div>
                <div class="comparison-panel">
                    <div class="comparison-header">After</div>
                    <div id="comparison-after" class="comparison-image-container">
                        <!-- After image inserted here -->
                    </div>
                    <div id="comparison-after-description" class="comparison-description">
                        <!-- Description -->
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="modal-close-comparison-btn">Close</button>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Overlay -->
    <div id="shortcuts-overlay" class="shortcuts-overlay hidden" role="dialog" aria-modal="true">
        <div class="shortcuts-content">
            <h2>‚å®Ô∏è Keyboard Shortcuts</h2>
            <div class="shortcuts-grid">
                <div class="shortcut-item">
                    <kbd>Space</kbd>
                    <span>Start/Stop recording</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Esc</kbd>
                    <span>Cancel recording / Close modal</span>
                </div>
                <div class="shortcut-item">
                    <kbd>?</kbd>
                    <span>Show this help</span>
                </div>
                <div class="shortcut-item">
                    <kbd>N</kbd>
                    <span>New session</span>
                </div>
                <div class="shortcut-item">
                    <kbd>S</kbd>
                    <span>Show sessions list</span>
                </div>
                <div class="shortcut-item">
                    <kbd>M</kbd>
                    <span>Open model selector</span>
                </div>
                <div class="shortcut-item">
                    <kbd>A</kbd>
                    <span>Show analytics</span>
                </div>
                <div class="shortcut-item">
                    <kbd>I</kbd>
                    <span>Server information</span>
                </div>
            </div>
            <button class="btn btn-secondary" onclick="window.app.hideShortcuts()">Close</button>
        </div>
    </div>
</body>
</html>
